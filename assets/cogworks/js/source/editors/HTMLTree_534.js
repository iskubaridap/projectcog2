define([],function(){
	return [function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x7,_x8,_x9){var _again=true;_function:while(_again){var object=_x7,property=_x8,receiver=_x9;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x7=parent;_x8=property;_x9=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Editor=require("./Editor");var parseDOMTree=require("../helpers/parseDOMTree");var getHTMLForNode=require("../helpers/getHTMLForNode");var componentTreeToArray=require("../helpers/componentTreeToArray");var escapeRegexString=require("../helpers/escapeRegexString");var keyChecker=require("../helpers/keyChecker");var isContextClick=require("../helpers/isContextClick");var unescapeHTML=require("../helpers/unescapeHTML");var clone=require("clone");var deepEqual=require("deep-equal");var ButtonOption=require("../panels/ButtonOption");var TextBoxOption=require("../panels/TextBoxOption");var TextBoxLockedContentOption=require("../panels/TextBoxLockedContentOption");var DoubleTextBoxOption=require("../panels/DoubleTextBoxOption");var GroupOption=require("../panels/GroupOption");var LinkOption=require("../panels/LinkOption");var CSSResource=require("../resources/CSSResource");var SuggestionTooltip=require("../panels/SuggestionTooltip");var HTMLTree=function(_Editor){_inherits(HTMLTree,_Editor);function HTMLTree(){_classCallCheck(this,HTMLTree);_get(Object.getPrototypeOf(HTMLTree.prototype),"constructor",this).call(this,"HTML");this.system=true;this.element=$('\n\t\t\t<div class="html-tree editor">\n\t\t\t\t<div class="toolbar">\n\t\t\t\t\t<div class="split-button">\n\t\t\t\t\t\t<a class="button darkgray previous icon" title="Previous Component"><i class="material-icons">keyboard_arrow_left</i></a><a class="button darkgray next icon" title="Next Component"><i class="material-icons">keyboard_arrow_right</i></a><a class="button darkgray parent icon" title="Parent Component"><i class="material-icons">keyboard_arrow_up</i></a>\n\t\t\t\t\t\t<a class="button darkgray search icon" title="Search HTML"><i class="material-icons">search</i></a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<input type="search" class="search-input" placeholder="Find elements by text or CSS selector" />\n\t\t\t\t\t<span class="number-results"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="content"></div>\n\t\t\t\t<div class="handle horizontal" \n\t\t\t\t\tdata-type="n" data-max="500" data-target="#editor-panel .html-tree .attribute-panel"\n\t\t\t\t\tdata-min="30" data-toggle-class="expanded"\n\t\t\t\t\tdata-toggle-enable="42" data-toggle-disable="70"></div>\n\t\t\t\t<div class="attribute-panel">\n\t\t\t\t\t<div class="header">Attributes</div>\n\t\t\t\t\t<div class="message-holder"></div>\n\t\t\t\t\t<div class="fields"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t');this.domTree=this.element.find(".content");this.treeElementToDOM=new WeakMap;this.domToTreeElement=new WeakMap;this.componentToTreeElement=new WeakMap;this.parseToTreeElement=new WeakMap;this.parseToSpan=new WeakMap;this.expandedElementsMap=new WeakMap;this.heightBeforeContract=180;this.parsedPageTree=null;this.activeTooltip=null;this.searchMatches=[];this.numberResults=this.element.find(".number-results");this.resultIndex=0;this.lastResultHighlightElement=null;this.parentButton=this.element.find(".toolbar .parent");this.previousButton=this.element.find(".toolbar .previous");this.nextButton=this.element.find(".toolbar .next");this.searchButton=this.element.find(".toolbar .search");this.searchInput=this.element.find(".toolbar .search-input");this.attributesGroup=new GroupOption({id:"attributes"});this.attributesPanel=this.element.find(".attribute-panel");this.attributesPanel.find(".fields").append(this.attributesGroup.update());this.attributesMessageHolder=this.attributesPanel.find(".message-holder");this.attributesPanelHandle=this.element.find(".html-column .html .handle");this.componentSelectedListener=this.componentSelected.bind(this);this.componentUpdatedListener=this.componentUpdated.bind(this);this.componentUnselectedListener=this.componentUnselected.bind(this);this.resourceChangedListener=this.resourceChanged.bind(this);this.contextMetaChangedListener=this.contextMetaChanged.bind(this);this.nodeFocusedListener=this.nodeFocused.bind(this);this._attributesFormTimer=null;this._attributesFormFunc=function(){this.updateAttributesForm()}.bind(this)}_createClass(HTMLTree,[{key:"destructor",value:function destructor(){this.attributesGroup.empty();this.element.remove()}},{key:"bindEventListeners",value:function bindEventListeners(){_get(Object.getPrototypeOf(HTMLTree.prototype),"bindEventListeners",this).call(this);var dom=this.element;dom.on("mousedown","> .content b",this.mouseDownItem.bind(this));dom.on("mousedown","> .content div > .close-tag",this.mouseDownItem.bind(this));dom.on("mousedown","> .content i",this.arrowClick.bind(this));dom.on("dblclick","> .content b",this.doubleClickItem.bind(this));dom.on("dblclick","> .content div > .close-tag",this.doubleClickItem.bind(this));dom.on("mouseenter","> .content b",this.enterItem.bind(this));dom.on("mouseenter","> .content div > .close-tag",this.enterItem.bind(this));dom.on("mouseleave","> .content b",this.leaveItem.bind(this));dom.on("mouseleave","> .content div > .close-tag",this.leaveItem.bind(this));dom.on("click",".attribute-panel .header",this.attributesFormClick.bind(this));dom.on("click",".toolbar .previous",this.clickFocusPrevious.bind(this));dom.on("click",".toolbar .next",this.clickFocusNext.bind(this));dom.on("click",".toolbar .parent",this.clickFocusParent.bind(this));dom.on("click",".toolbar .search",this.clickSearchButton.bind(this));dom.on("focusout",".search-input",this.focusoutSearchInput.bind(this));dom.on("input",".search-input",this.inputSearchInput.bind(this));dom.on("keydown",".search-input",this.keydownSearchInput.bind(this));dom.on("focusin",".tb-locked [contenteditable]",this.focusinClassInput.bind(this));dom.on("focusout",".tb-locked [contenteditable]",this.focusoutClassInput.bind(this));app.on("component-selected",this.componentSelectedListener);app.on("component-updated",this.componentUpdatedListener);app.on("component-unselected",this.componentUnselectedListener);app.on("node-focused",this.nodeFocusedListener);app.on("resource-changed",this.resourceChangedListener);app.on("context-meta-changed",this.contextMetaChangedListener)}},{key:"unbindEventListeners",value:function unbindEventListeners(){_get(Object.getPrototypeOf(HTMLTree.prototype),"unbindEventListeners",this).call(this);this.element.off();app.off("component-selected",this.componentSelectedListener);app.off("component-updated",this.componentUpdatedListener);app.off("component-unselected",this.componentUnselectedListener);app.off("node-focused",this.nodeFocusedListener);app.off("resource-changed",this.resourceChangedListener);app.off("context-meta-changed",this.contextMetaChangedListener);if(this.activeTooltip){this.activeTooltip.destroy();this.activeTooltip=null}}},{key:"activate",value:function activate(){_get(Object.getPrototypeOf(HTMLTree.prototype),"activate",this).call(this);this.cancelSearch()}},{key:"componentSelected",value:function componentSelected(components){this.markFocusedTreeElement();this.scheduleAttributesFormUpdate()}},{key:"componentUnselected",value:function componentUnselected(components){this.markFocusedTreeElement();this.scheduleAttributesFormUpdate()}},{key:"contextMetaChanged",value:function contextMetaChanged(){this.scheduleUpdate()}},{key:"resourceChanged",value:function resourceChanged(type,action,res){if(type=="css"||type=="scss"||type=="font"){this.scheduleUpdate()}if(type=="folder"&&res.containsInstanceOf(CSSResource)){this.scheduleUpdate()}if(type=="page"&&app.context.page==res&&app.context.pages.has(res.name)){this.scheduleUpdate()}}},{key:"nodeFocused",value:function nodeFocused(){this.scheduleAttributesFormUpdate()}},{key:"componentUpdated",value:function componentUpdated(component){if(app.isInlineEditingActive())return;this.scheduleUpdate()}},{key:"enterItem",value:function enterItem(e){var element=this.treeElementToDOM.get(e.currentTarget)||this.treeElementToDOM.get(e.currentTarget.parentNode);if(element){app.canvas.highlightDOMElement(element)}}},{key:"leaveItem",value:function leaveItem(e){app.canvas.removeDOMHighlight()}},{key:"copyNodeAsHTML",value:function copyNodeAsHTML(node){var html=getHTMLForNode(node,app.context.page);electron.clipboardSet(html,html)}},{key:"copyAttributes",value:function copyAttributes(node){var component=app.context.page.findComponentForElement(node);var path=component.getPathForChildElement(node);var overrides=clone(component.getOverrides(path));delete overrides.id;app.attributesCopyBuffer=overrides}},{key:"pasteAttributes",value:function pasteAttributes(node){var component=app.context.page.findComponentForElement(node);var path=component.getPathForChildElement(node);if(component.isChildElementBlacklisted(node))return false;if(!app.attributesCopyBuffer)return false;var newOverrides=clone(app.attributesCopyBuffer);var oldOverrides=clone(component.getOverrides(path));if(oldOverrides.id){newOverrides.id=oldOverrides.id}component.removeAllOverrides(path);component.setOverrides(path,newOverrides);component.update();app.context.history.add({name:"Paste Attributes",undo:function undo(){component.removeAllOverrides(path);component.setOverrides(path,oldOverrides);component.update()},redo:function redo(){component.removeAllOverrides(path);component.setOverrides(path,newOverrides);component.update()}})}},{key:"mouseDownItem",value:function mouseDownItem(e){if(e.target.nodeType=="I"){return}var element=this.treeElementToDOM.get(e.currentTarget)||this.treeElementToDOM.get(e.currentTarget.parentNode);if(!element)return false;var component=app.context.page.findComponentForElement(element);if(!component)return;var canCopy=false;var canPaste=false;var path=component.getPathForChildElement(element);var pathOverrides=clone(component.getOverrides(path));delete pathOverrides.id;if(Object.keys(pathOverrides).length>0){canCopy=true}if(!component.isChildElementBlacklisted(element)&&Object.keys(app.attributesCopyBuffer||{}).length>0){canPaste=true}if(isContextClick(e)){var items=[{name:"Copy As HTML",action:this.copyNodeAsHTML.bind(this,element)},{name:"Copy Attributes",disabled:!canCopy,action:this.copyAttributes.bind(this,element)},{name:"Paste Attributes",disabled:!canPaste,action:this.pasteAttributes.bind(this,element)}];app.contextMenu.show(e.pageX,e.pageY,items);e.preventDefault();e.stopImmediatePropagation();return}if(component&&!component.isFocused()){component.focus()}this.setFocusedDOMNode(component,element);this.markFocusedTreeElement();setTimeout(function(){app.canvas.highlightDOMElement(element)},20)}},{key:"doubleClickItem",value:function doubleClickItem(){if(!this.attributesPanel.is(".expanded")){this.toggleAttributesForm(true)}}},{key:"clickSearchButton",value:function clickSearchButton(){this.searchButton.hide();this.searchInput.show().focus()}},{key:"focusoutSearchInput",value:function focusoutSearchInput(e){if(!this.searchInput.val().trim().length){this.cancelSearch()}}},{key:"inputSearchInput",value:function inputSearchInput(e){if(this.isSearching()){this.doSearch()}else{this.resetSearch()}}},{key:"keydownSearchInput",value:function keydownSearchInput(e){if(e.which==27){this.cancelSearch();return}if(e.which==13||e.which==114){if(!this.searchMatches.length){return}if(e.shiftKey){this.resultIndex--;if(this.resultIndex<0){if(this.searchMatches.length){this.resultIndex=this.searchMatches.length-1}else{this.resultIndex=0}}}else{this.resultIndex++;if(this.resultIndex>=this.searchMatches.length){this.resultIndex=0}}this.clearSearch();this.highlightSearchMatch()}if(keyChecker(e.which==70&&e.ctrlKey,e.which==70&&e.metaKey)){this.searchInput[0].select()}}},{key:"cancelSearch",value:function cancelSearch(){this.searchButton.css("display","inline-block");this.searchInput.val("").hide();this.resetSearch()}},{key:"focusinClassInput",value:function focusinClassInput(e){this.activeTooltip=new SuggestionTooltip($(e.target),{items:Array.from(new Set(app.context.getUserClassNames().concat(app.framework.getClassSuggestions())))},{onSelect:function onSelect(val,method,event){if(method!="click"){event.preventDefault()}}})}},{key:"focusoutClassInput",value:function focusoutClassInput(e){if(this.activeTooltip){this.activeTooltip.destroy();this.activeTooltip=null}}},{key:"setFocusedDOMNode",value:function setFocusedDOMNode(component,node){component.setFocusNode(node);app.trigger("node-focused")}},{key:"markFocusedTreeElement",value:function markFocusedTreeElement(){this.unmarkTreeElements("focused");if(app.context.page.hasFocusedNode()){var element=app.context.page.getFocusedNode();this.markTreeElement(element,"focused");this.expandAllToElement(element);this.scrollCorrespondingNodeIntoView(element)}this.updateNavigationButtons()}},{key:"highlightSearchMatch",value:function highlightSearchMatch(){this.numberResults.show().text("0 of 0");if(!this.searchMatches.length||!this.searchMatches[this.resultIndex])return;var result=this.searchMatches[this.resultIndex];this.numberResults.show().text(String(this.resultIndex+1)+" of "+String(this.searchMatches.length));var treeElement=this.parseToSpan.get(result.item);this.expandAllToNode(treeElement);this.lastResultHighlightElement=treeElement;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=result.matches[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var match=_step.value;var node=this.parseToTreeElement.get(result.item);if(!node)continue;switch(match.type){case"tag":var tagName=node.querySelector("tag-name");highlightDomSubstring(tagName,tagName.innerHTML,match.start,match.end,4);var closeTag=node.querySelector(".close-tag");if(closeTag){highlightDomSubstring(closeTag,closeTag.innerHTML,match.start,match.end,5);var next=node.nextSibling;if(next.matches("div")){highlightDomSubstring(next.lastChild,next.lastChild.innerHTML,match.start,match.end,5)}}this.scrollNodeIntoView(node.querySelector("tag-name"));break;case"node":node.classList.add("highlighted");var next=node.nextSibling;if(next.matches("div")){next.classList.add("highlighted")}this.scrollNodeIntoView(node);break;case"text":highlightDomSubstring(node,unescapeHTML(node.innerHTML),match.start,match.end,node.textContent[0]=='"'?1:0);this.scrollNodeIntoView(node.querySelector("highlight"));break;case"attribute-name":var attr=this.parseToTreeElement.get(match.attribute);highlightDomSubstring(attr.name,attr.name.innerHTML,match.start,match.end);this.scrollNodeIntoView(node.querySelector("highlight"));break;case"attribute-value":var attr=this.parseToTreeElement.get(match.attribute);highlightDomSubstring(attr.value,attr.value.innerHTML,match.start,match.end,1);this.scrollNodeIntoView(node.querySelector("highlight"));break}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator["return"]){_iterator["return"]()}}finally{if(_didIteratorError){throw _iteratorError}}}function highlightDomSubstring(dom,content,start,end){var offset=arguments.length<=4||arguments[4]===undefined?0:arguments[4];for(var i=0;i<content.length;i++){if(i>start+offset)break;if(content[i]=="<"){if(content[i+1]=="/"){offset+=12}else{offset+=11}}}var before=content.slice(0,start+offset),match=content.slice(start+offset,end+offset),after=content.slice(end+offset);var newContent=before+"<highlight>"+match+"</highlight>"+after;dom.innerHTML=newContent}}},{key:"calculateResultIndex",value:function calculateResultIndex(){this.resultIndex=0;for(var i=0;i<this.searchMatches.length;i++){var result=this.searchMatches[i];if(this.parseToSpan.get(result.item)===this.lastResultHighlightElement){this.resultIndex=i;break}}}},{key:"searchTree",value:function searchTree(query){var searchMatches=[];var domMatches=[];var queryRegex=new RegExp(escapeRegexString(query),"ig");try{domMatches=Array.from(app.context.page.html.element[0].ownerDocument.querySelectorAll(query))}catch(e){}walk(this.parsedPageTree);this.searchMatches=searchMatches;return searchMatches.length;function walk(item){var result={item:item,matches:[]};if(item.text){item.text.replace(queryRegex,function(match,offset){result.matches.push({type:"text",start:offset,end:offset+match.length});return match});if(result.matches.length){searchMatches.push(result)}return}if(domMatches.indexOf(item.element)!=-1){result.matches.push({type:"node"})}if(queryRegex.test(item.tag)){item.tag.replace(queryRegex,function(match,offset){result.matches.push({type:"tag",start:offset,end:offset+match.length});return match})}var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=item.attributes[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var attr=_step2.value;if(queryRegex.test(attr.name)){attr.name.replace(queryRegex,function(match,offset){result.matches.push({type:"attribute-name",attribute:attr,start:offset,end:offset+match.length});return match})}if(attr.value&&queryRegex.test(attr.value)){attr.value.replace(queryRegex,function(match,offset){result.matches.push({type:"attribute-value",attribute:attr,start:offset,end:offset+match.length});return match})}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2["return"]){_iterator2["return"]()}}finally{if(_didIteratorError2){throw _iteratorError2}}}if(result.matches.length){searchMatches.push(result)}var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=item.children[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var child=_step3.value;walk(child)}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3["return"]){_iterator3["return"]()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}}},{key:"isSearching",value:function isSearching(){return this.searchInput.val().length}},{key:"doSearch",value:function doSearch(){this.searchTree(this.searchInput.val());this.calculateResultIndex();this.clearSearch();this.highlightSearchMatch()}},{key:"clearSearch",value:function clearSearch(){var highlights=this.element[0].querySelectorAll("highlight");var parents=new Set;var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=highlights[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var high=_step4.value;parents.add(high.parentNode);high.parentNode.replaceChild(high.firstChild,high)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4["return"]){_iterator4["return"]()}}finally{if(_didIteratorError4){throw _iteratorError4}}}parents.forEach(function(p){return p.normalize()});parents.clear();this.element.find(".highlighted").removeClass("highlighted");this.numberResults.hide()}},{key:"resetSearch",value:function resetSearch(){this.clearSearch();this.searchMatches=[];this.lastResultHighlightElement=null;this.resultIndex=0}},{key:"scrollCorrespondingNodeIntoView",value:function scrollCorrespondingNodeIntoView(element){var span=this.domToTreeElement.get(element);if(!span)return;span.scrollIntoViewIfNeeded()}},{key:"scrollNodeIntoView",value:function scrollNodeIntoView(span){if(!span)return;span.scrollIntoViewIfNeeded()}},{key:"markTreeElement",value:function markTreeElement(element,cls){var span=this.domToTreeElement.get(element);if(!span)return;span.lastChild.classList.add(cls);if(span.nextSibling&&span.nextSibling.matches("div")){span.nextSibling.lastChild.classList.add(cls)}}},{key:"unmarkTreeElements",value:function unmarkTreeElements(cls){this.element.find("."+cls).removeClass(cls)}},{key:"expandAllToElement",value:function expandAllToElement(element){var updateExpandedMap=arguments.length<=1||arguments[1]===undefined?true:arguments[1];var span=this.domToTreeElement.get(element);this.expandAllToNode(span,updateExpandedMap)}},{key:"expandAllToNode",value:function expandAllToNode(node){var updateExpandedMap=arguments.length<=1||arguments[1]===undefined?true:arguments[1];var parents=$(node).parentsUntil(this.domTree,"div").show();var spans=parents.prev("span");spans.children("i").addClass("down");spans.children("b").addClass("expanded");if(updateExpandedMap){var that=this;spans.each(function(){that.updateExpandedState(this,true)})}}},{key:"arrowClick",value:function arrowClick(e){var span=e.target.parentNode;this.expandContract(span);this.updateExpandedState(span,span.lastChild.classList.contains("expanded"))}},{key:"updateExpandedState",value:function updateExpandedState(element){var newState=arguments.length<=1||arguments[1]===undefined?true:arguments[1];var domElem=this.treeElementToDOM.get(element);if(!domElem)return;var comp=app.context.page.findComponentForElement(domElem);if(!comp)return;var path=comp.getPathForChildElement(domElem);if(!path)return;if(!this.expandedElementsMap.has(comp)){this.expandedElementsMap.set(comp,{})}this.expandedElementsMap.get(comp)[path]=newState}},{key:"expandContract",value:function expandContract(treeElement){var state=arguments.length<=1||arguments[1]===undefined?"toggle":arguments[1];var span=$(treeElement);var i=span.children("i");var b=span.children("b");if(!span.next("div").length){return}if(state=="toggle"){span.next("div").slideToggle(100);i.toggleClass("down");b.toggleClass("expanded")}else{span.next("div")[state?"show":"hide"]();i.toggleClass("down",state);b.toggleClass("expanded",state)}}},{key:"clickFocusPrevious",value:function clickFocusPrevious(){var node=app.context.page.getFocusedComponent();if(node&&node.hasPreviousSibling()){node.focusPreviousSibling()}}},{key:"clickFocusNext",value:function clickFocusNext(){var node=app.context.page.getFocusedComponent();if(node&&node.hasNextSibling()){node.focusNextSibling()}}},{key:"clickFocusParent",value:function clickFocusParent(){var node=app.context.page.getFocusedComponent();if(node&&node.parent){node.focusParent()}}},{key:"updateNavigationButtons",value:function updateNavigationButtons(){var node=app.context.page.getFocusedComponent();this.parentButton.toggleClass("disabled",!node||!node.parent);this.previousButton.toggleClass("disabled",!node||!node.hasPreviousSibling());this.nextButton.toggleClass("disabled",!node||!node.hasNextSibling())}},{key:"attributesFormClick",value:function attributesFormClick(){this.toggleAttributesForm()}},{key:"toggleAttributesForm",value:function toggleAttributesForm(){var expand=arguments.length<=0||arguments[0]===undefined?null:arguments[0];if(expand===null){expand=!this.attributesPanel.is(".expanded")}if(expand){this.attributesPanel.height(this.heightBeforeContract);this.attributesPanel.addClass("expanded")}else{
this.heightBeforeContract=this.attributesPanel.height();this.attributesPanel.height(28);this.attributesPanel.removeClass("expanded")}}},{key:"scheduleAttributesFormUpdate",value:function scheduleAttributesFormUpdate(){clearTimeout(this._attributesFormTimer);this._attributesFormTimer=setTimeout(this._attributesFormFunc,50)}},{key:"updateAttributesForm",value:function updateAttributesForm(){this.attributesGroup.empty();this.attributesMessageHolder.empty();if(!app.context.page.hasFocusedNode()||!app.context.page.hasFocusedComponent()){this.attributesMessageHolder.html('<p class="message">No element selected.</p>');this.attributesGroup.update();return}var node=app.context.page.getFocusedNode();var component=app.context.page.findComponentForElement(node);if(component.isChildElementBlacklisted(node)){this.attributesMessageHolder.html('<p class="message">This element doesn\'t accept attributes.</p>');this.attributesGroup.update();return}var that=this;var path=component.getPathForChildElement(node);var idField=new TextBoxOption({label:"ID",value:component.getOverride(path,"id"),onCommit:applyAttributes});var classField=new TextBoxLockedContentOption({label:"Class Names",lockedContent:component.extractSystemClasses(path),value:component.getUserClasses(path),onCommit:applyAttributes});this.attributesGroup.add(idField);this.attributesGroup.add(classField);var overridesGroup=new GroupOption({id:"overrides-group"});this.attributesGroup.add(overridesGroup);var fields=[];var overrides=component.getOverrides(path);for(var key in overrides){if(key=="id"||key=="class"){continue}fields.push(new DoubleTextBoxOption({key:key,value:overrides[key],onCommit:applyAttributes,onDelete:deleteAttribute}))}if(fields.length){var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=fields[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var f=_step5.value;overridesGroup.add(f)}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5["return"]){_iterator5["return"]()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}var controlGroup=new GroupOption({id:"control-group"});controlGroup.add(new ButtonOption({text:"Apply",onClick:applyAttributes}));controlGroup.add(new ButtonOption({text:"Add Attribute",icon:"add",onClick:function onClick(){var tmp=new DoubleTextBoxOption({key:"",value:"",onCommit:applyAttributes,onDelete:deleteAttribute});overridesGroup.element.append(tmp.update());overridesGroup.show();fields.push(tmp);tmp.element.find("input:first").focus()}}));this.attributesGroup.add(controlGroup);this.attributesGroup.update();this.attributesPanel.show();this.attributesPanelHandle.show();function applyAttributes(){var oldOverrides=clone(component.getOverrides(path));var newOverrides={};newOverrides.id=oldOverrides.id;if(component.isIDValid(idField.val().trim())){newOverrides.id=idField.val().trim()}newOverrides["class"]=classField.val().trim().replace(/\s+/g," ");var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=fields[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var textBox=_step6.value;var tmp=textBox.val();var key=tmp.key.trim().toLowerCase();var val=tmp.value.trim();if(key=="id"&&!component.isIDValid(val)){val=oldOverrides.id}if(!key)continue;newOverrides[key]=val}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6["return"]){_iterator6["return"]()}}finally{if(_didIteratorError6){throw _iteratorError6}}}if(newOverrides["class"]==""){delete newOverrides["class"]}if(newOverrides.id==""){delete newOverrides.id}if(deepEqual(oldOverrides,newOverrides)){that.updateAttributesForm();return}component.removeAllOverrides(path);component.setOverrides(path,newOverrides);component.update();app.context.history.add({name:"Change Element Attributes",undo:function undo(){component.removeAllOverrides(path);component.setOverrides(path,oldOverrides);component.update()},redo:function redo(){component.removeAllOverrides(path);component.setOverrides(path,newOverrides);component.update()}})}function deleteAttribute(textBox){var index=fields.indexOf(textBox);fields.splice(index,1);textBox.element.remove()}}},{key:"update",value:function update(){var root=document.createDocumentFragment();var map=this.treeElementToDOM;var reverseMap=this.domToTreeElement;var treeMap=this.componentToTreeElement;var parseMap=this.parseToTreeElement;var parseToSpan=this.parseToSpan;var scrollTop=this.element[0].scrollTop;this.parsedPageTree=parseDOMTree(app.context.page.html.element[0],app.context.page,{removeSystemElements:true});walk(this.parsedPageTree,root);function walk(item,tip){var tmp=document.createElement("span");var b=document.createElement("b");var em=document.createElement("em");b.appendChild(createOpenTag(item,tmp));b.appendChild(em);b.appendChild(createCloseTag(item));map.set(tmp,item.element);reverseMap.set(item.element,tmp);parseMap.set(item,tmp);parseToSpan.set(item,tmp);if(app.context.page.domToComponent.has(item.element)){treeMap.set(app.context.page.domToComponent.get(item.element),tmp)}tmp.appendChild(b);tip.appendChild(tmp);if(item.children.length==1&&item.children[0].text){var textNode=document.createTextNode(item.children[0].text);em.appendChild(textNode);parseMap.set(item.children[0],em);parseToSpan.set(item.children[0],tmp)}else if(item.children.length){em.appendChild(document.createTextNode("..."));var div=document.createElement("div");for(var i=0;i<item.children.length;i++){if(item.children[i].text){addTextNode(item.children[i],div);continue}walk(item.children[i],div)}var expandedClosingTag=createCloseTag(item);map.set(expandedClosingTag,item.element);div.appendChild(expandedClosingTag);tip.appendChild(div);tmp.insertBefore(document.createElement("i"),b)}}function addTextNode(item,node){if(!item.text||!item.text.trim().length)return;var tmpSpan=document.createElement("span");var tmpB=document.createElement("b");var textNode=document.createTextNode('"'+item.text+'"');tmpB.appendChild(textNode);tmpSpan.appendChild(tmpB);parseMap.set(item,tmpB);parseToSpan.set(item,tmpSpan);node.appendChild(tmpSpan)}function createOpenTag(item,span){var strong=document.createElement("strong");strong.classList.add("open-tag");var tagName=document.createElement("tag-name");tagName.appendChild(document.createTextNode("<"+item.tag));strong.appendChild(tagName);var attr=Array.from(item.attributes);var isID=false;for(var i=0;i<attr.length;i++){if(attr[i].name=="id"){var tmp=attr[0];attr[0]=attr[i];attr[i]=tmp;isID=true;break}}for(var i=0;i<attr.length;i++){if(attr[i].name=="class"){if(isID){var tmp=attr[1];attr[1]=attr[i];attr[i]=tmp}else{var tmp=attr[0];attr[0]=attr[i];attr[i]=tmp}break}}for(var i=0;i<attr.length;i++){var attrName=document.createElement("attr-name");if(attr[i].value){attrName.appendChild(document.createTextNode(attr[i].name+"="));strong.appendChild(document.createTextNode(" "));strong.appendChild(attrName);var attrValue=document.createElement("attr-value");attrValue.appendChild(document.createTextNode('"'+attr[i].value+'"'));strong.appendChild(attrValue);parseMap.set(attr[i],{name:attrName,value:attrValue})}else{attrName.appendChild(document.createTextNode(attr[i].name));strong.appendChild(document.createTextNode(" "));strong.appendChild(attrName);parseMap.set(attr[i],{name:attrName})}parseToSpan.set(attr[i],span)}if(item.selfclosing){strong.appendChild(document.createTextNode(" /"))}strong.appendChild(document.createTextNode(">"));strong.normalize();return strong}function createCloseTag(item){if(item.selfclosing){return document.createDocumentFragment()}var strong=document.createElement("strong");strong.classList.add("close-tag");strong.appendChild(document.createTextNode("</"+item.tag+">"));return strong}this.domTree.html(root);var components=componentTreeToArray(app.context.page.html);var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=components[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var comp=_step7.value;if(this.expandedElementsMap.has(comp)){for(var path in this.expandedElementsMap.get(comp)){var span=this.domToTreeElement.get(comp.findChildElementByPath(path));if(!span)continue;this.expandContract(span,this.expandedElementsMap.get(comp)[path])}}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7["return"]){_iterator7["return"]()}}finally{if(_didIteratorError7){throw _iteratorError7}}}this.markFocusedTreeElement();this.updateAttributesForm();if(this.isSearching()){this.doSearch()}this.element[0].scrollTop=scrollTop;return this.element}}]);return HTMLTree}(Editor);module.exports=HTMLTree},{"../helpers/componentTreeToArray":551,"../helpers/escapeRegexString":561,"../helpers/getHTMLForNode":573,"../helpers/isContextClick":584,"../helpers/keyChecker":586,"../helpers/parseDOMTree":594,"../helpers/unescapeHTML":619,"../panels/ButtonOption":1212,"../panels/DoubleTextBoxOption":1219,"../panels/GroupOption":1222,"../panels/LinkOption":1225,"../panels/SuggestionTooltip":1241,"../panels/TextBoxLockedContentOption":1242,"../panels/TextBoxOption":1243,"../resources/CSSResource":1249,"./Editor":532,"clone":739,"deep-equal":971}]
});