define([],function(){
	return [function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x10,_x11,_x12){var _again=true;_function:while(_again){var object=_x10,property=_x11,receiver=_x12;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x10=parent;_x11=property;_x12=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Editor=require("./Editor");var prettyDOMNodeName=require("../helpers/prettyDOMNodeName");var formatCSSSelector=require("../helpers/formatCSSSelector");var escapeHTML=require("escape-html");var escapeRegexString=require("../helpers/escapeRegexString");var CSSRule=require("../base/CSSRule");var CSSBlock=require("../base/CSSBlock");var CSSBlockStyle=require("../base/CSSBlockStyle");var CSSKeyframes=require("../base/CSSKeyframes");var cssProperties=require("../config/css-properties");var SuggestionTooltip=require("../panels/SuggestionTooltip");var dragScroll=require("../helpers/dragScroll");var parseCSS=require("../helpers/parseCSS");var selectElementContents=require("../helpers/selectElementContents");var quickParseCSSRules=require("../helpers/quickParseCSSRules");var keyChecker=require("../helpers/keyChecker");var hasSelection=require("../helpers/hasSelection");var insertAtCaret=require("../helpers/insertAtCaret");var saveRestoreCaret=require("../helpers/saveRestoreCaretPosition");var highlightMatches=require("../helpers/highlightMatches");var compareSelectorSpecificity=require("../helpers/compareSelectorSpecificity");var multipleTreeSelection=require("../helpers/multipleTreeSelection");var isSelectionClick=require("../helpers/isSelectionClick");var ActiveStyles=function(_Editor){_inherits(ActiveStyles,_Editor);function ActiveStyles(){_classCallCheck(this,ActiveStyles);_get(Object.getPrototypeOf(ActiveStyles.prototype),"constructor",this).call(this,"Styles");this.system=true;this.element=$('\n\t\t\t<div class="active-styles css-editor editor">\n\t\t\t\t<div class="toolbar">\n\t\t\t\t\t<div class="main">\n\t\t\t\t\t\t<div class="split-button">\n\t\t\t\t\t\t\t<a class="create button darkgray">Create</a><a class="create-choose button darkgray">&nbsp;</a>\n\t\t\t\t\t\t\t<a class="button darkgray search icon disabled" title="Search styles"><i class="material-icons">search</i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<input type="search" class="search-input" placeholder="Search styles" />\n\t\t\t\t\t\t<span class="number-results"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="multiple-selection" style="display:none">\n\t\t\t\t\t\t<a class="button darkgray copy" title="Copy to">Copy to <span class="caret-down"></span></a>\n\t\t\t\t\t\t<a class="button darkgray move" title="Move to">Move to <span class="caret-down"></span></a>\n\t\t\t\t\t\t<a class="button darkgray duplicate" title="Duplicate">Duplicate</span></a>\n\t\t\t\t\t\t<a class="button darkgray toggle" title="Disable">Disable</i></a>\n\t\t\t\t\t\t<a class="button darkgray delete" title="Delete">Delete</i></a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="content"></div>\n\t\t\t\t<div class="message">No element selected.</div>\n\t\t\t</div>\n\t\t');this.searchInput=this.element.find(".search-input");this.searchButton=this.element.find(".search.button");this.numberResults=this.element.find(".number-results");this.activeTooltip=null;this.searchRegex=null;this.resultIndex=0;this.resultHighlightID=null;this.cssBlocks=[];this.supportsMultiSelection=true;this.multipleSelection=null;this.blockMatchedSelectors=new WeakMap;this.focusOutTimeout=null;this.focus=null;this.pending=null;this.animationsRunning=false;this.ignoreFocusout=false;this.mode="active-styles";this.targetCSSResource=null;this.domToCSSItem=new WeakMap;this.cssItemToDOM=new WeakMap;this.pageActivatedListener=this.pageActivated.bind(this);this.componentSelectedListener=this.componentSelected.bind(this);this.componentUnselectedListener=this.componentUnselected.bind(this);this.componentUpdatedListener=this.componentUpdated.bind(this);this.contextCSSChangedListener=this.contextCSSChanged.bind(this);this.contextSASSChangedListener=this.contextSASSChanged.bind(this);this.nodeFocusedListener=this.nodeFocused.bind(this);this.resourceChangedListener=this.resourceChanged.bind(this);this.appMousedownListener=this.appMousedown.bind(this);this.contextChangedListener=this.contextChanged.bind(this)}_createClass(ActiveStyles,[{key:"destructor",value:function destructor(){this.cssBlocks=[];this.cssGroups=[];this.clearModifiedBlocks();this.element.remove()}},{key:"bindEventListeners",value:function bindEventListeners(){_get(Object.getPrototypeOf(ActiveStyles.prototype),"bindEventListeners",this).call(this);var dom=this.element;dom.on("keydown","[contenteditable]",this.onEditableKeydown.bind(this));dom.on("paste","[contenteditable]",this.onEditablePaste.bind(this));dom.on("input","[contenteditable]",this.onEditableInput.bind(this));dom.on("focusin","[contenteditable]",this.onEditableFocus.bind(this));dom.on("focusout","[contenteditable]",this.onEditableFocusout.bind(this));dom.on("mousedown",".css-block.temp",this.clickTempBlock.bind(this));dom.on("mousedown",".css-block",this.clickCSSBlock.bind(this));dom.on("mousedown",".css-block:not(.locked) .color",this.colorClick.bind(this));dom.on("mousedown",".css-block:not(.locked) .css-property",this.clickCSSProperty.bind(this));dom.on("mousedown",".css-block:not(.locked) .css-value",this.clickCSSValue.bind(this));dom.on("mousedown",".css-block:not(.locked) .selector",this.clickSelector.bind(this));dom.on("mousedown",".css-block:not(.locked) .media",this.clickMediaQuery.bind(this));dom.on("mousedown",".css-block:not(.locked) .keyframes-name",this.clickKeyframesName.bind(this));dom.on("mousedown",".css-block:not(.system) .origin",this.clickOrigin.bind(this));dom.on("click",".css-block:not(.locked) .opening-brace",this.clickOpeningBrace.bind(this));dom.on("click",".css-block:not(.locked) .closing-brace",this.clickClosingBrace.bind(this));dom.on("click",".css-block:not(.locked) .rules li",this.clickCSSRule.bind(this));dom.on("click",".menu",this.showContextMenu.bind(this));dom.on("click",".play-button",this.clickPlayButton.bind(this));dom.on("change","input[type=checkbox]",this.checkBoxChange.bind(this));dom.on("mouseenter",".css-block .selector",this.mouseenterSelector.bind(this));dom.on("mouseleave",".css-block .selector",this.mouseleaveSelector.bind(this));dom.on("click",".multiple-selection .button.copy",this.clickCopyMultipleButton.bind(this));dom.on("click",".multiple-selection .button.move",this.clickMoveMultipleButton.bind(this));dom.on("click",".multiple-selection .button.duplicate",this.clickDuplicateMultipleButton.bind(this));dom.on("click",".multiple-selection .button.delete",this.clickDeleteMultipleButton.bind(this));dom.on("click",".multiple-selection .button.toggle",this.clickToggleMultipleButton.bind(this));dom.on("click",".button.create",this.clickCreateStyleButton.bind(this));dom.on("click",".button.create-choose",this.clickCreateChooseStyleButton.bind(this));dom.on("click",".button.search",this.clickSearchButton.bind(this));dom.on("focusout",".search-input",this.focusoutSearchInput.bind(this));dom.on("input",".search-input",this.inputSearchInput.bind(this));dom.on("keydown",".search-input",this.keydownSearchInput.bind(this));dom.on("copy",this.onCopy.bind(this));app.on("page-activated",this.pageActivatedListener);app.on("component-selected",this.componentSelectedListener);app.on("component-unselected",this.componentUnselectedListener);app.on("component-updated",this.componentUpdatedListener);app.on("context-css-changed",this.contextCSSChangedListener);app.on("context-sass-changed",this.contextSASSChangedListener);app.on("node-focused",this.nodeFocusedListener);app.on("resource-changed",this.resourceChangedListener);app.on("mousedown",this.appMousedownListener);app.on("context-changed",this.contextChangedListener)}},{key:"unbindEventListeners",value:function unbindEventListeners(){_get(Object.getPrototypeOf(ActiveStyles.prototype),"unbindEventListeners",this).call(this);this.element.off();app.off("page-activated",this.pageActivatedListener);app.off("component-selected",this.componentSelectedListener);app.off("component-unselected",this.componentUnselectedListener);app.off("component-updated",this.componentUpdatedListener);app.off("context-css-changed",this.contextCSSChangedListener);app.off("context-sass-changed",this.contextSASSChangedListener);app.off("node-focused",this.nodeFocusedListener);app.off("resource-changed",this.resourceChangedListener);app.off("mousedown",this.appMousedownListener);app.off("context-changed",this.contextChangedListener)}},{key:"activate",value:function activate(){_get(Object.getPrototypeOf(ActiveStyles.prototype),"activate",this).call(this)}},{key:"deactivate",value:function deactivate(){_get(Object.getPrototypeOf(ActiveStyles.prototype),"deactivate",this).call(this);this.resetFocus();this.clearSelection();this.stopAnimations();if(!this.searchRegex){this.cancelSearch()}}},{key:"resourceChanged",value:function resourceChanged(type,action,res){if(type!="css")return;if(!Array.isArray(res)){res=[res]}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=res[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var css=_step.value;if(!app.context.hasResource(css)&&this.targetCSSResource==css){this.targetCSSResource=null;break}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator["return"]){_iterator["return"]()}}finally{if(_didIteratorError){throw _iteratorError}}}this.clearModifiedBlocks();this.scheduleUpdate()}},{key:"appMousedown",value:function appMousedown(e){if(e.target&&e.target.classList.contains("play-button")){return}this.stopAnimations()}},{key:"contextChanged",value:function contextChanged(){this.stopAnimations()}},{key:"pageActivated",value:function pageActivated(){this.scheduleUpdate()}},{key:"nodeFocused",value:function nodeFocused(){this.scheduleUpdate()}},{key:"componentSelected",value:function componentSelected(components){this.clearSelection();this.handlePendingChanges();this.stopAnimations();this.resetFocus();this.scheduleUpdate()}},{key:"componentUnselected",value:function componentUnselected(components){this.handlePendingChanges();this.stopAnimations();this.resetFocus();this.scheduleUpdate()}},{key:"componentUpdated",value:function componentUpdated(component){if(this.ignoreUpdatedEvent)return;if(app.isInlineEditingActive())return;this.handlePendingChanges();this.resetFocus();this.scheduleUpdate()}},{key:"contextCSSChanged",value:function contextCSSChanged(context,resources,block){this.clearSelection();if(this.ignoreUpdatedEvent)return;if(block){this.refreshBlock(block);this.updateSearch()}else{this.update()}}},{key:"contextSASSChanged",value:function contextSASSChanged(context){this.clearSelection();if(this.ignoreUpdatedEvent)return;this.update()}},{key:"getTargetCSSResource",value:function getTargetCSSResource(){if(this.targetCSSResource&&app.context.assets.css.contains(this.targetCSSResource)){return this.targetCSSResource}if(app.context.assets.css.getLocalCSSResources().length){this.targetCSSResource=app.context.assets.css.getLocalCSSResources()[0];return this.targetCSSResource}return null}},{key:"hasTextSelection",value:function hasTextSelection(){return hasSelection()}},{key:"addModifiedBlock",value:function addModifiedBlock(node,block){if(this.mode!="active-styles")return;if(!this._modifiedCSSBlocks){this._modifiedCSSBlocks={node:null,blocks:[]}}if(this._modifiedCSSBlocks.node!=node){this._modifiedCSSBlocks.blocks=[]}this._modifiedCSSBlocks.node=node;this._modifiedCSSBlocks.blocks.unshift(block)}},{key:"removeModifiedBlock",value:function removeModifiedBlock(node,block){var blocks=this.getModifiedBlocks(node);if(blocks.indexOf(block)==-1)return;blocks.splice(blocks.indexOf(block),1)}},{key:"clearModifiedBlocks",value:function clearModifiedBlocks(){this._modifiedCSSBlocks=null}},{key:"hasModifiedBlock",value:function hasModifiedBlock(node,block){var blocks=this.getModifiedBlocks(node);if(blocks.indexOf(block)==-1)return false;return true}},{key:"getModifiedBlocks",value:function getModifiedBlocks(node){if(!this._modifiedCSSBlocks)return[];if(this._modifiedCSSBlocks.node!=node)return[];return this._modifiedCSSBlocks.blocks}},{key:"hasMultipleSelection",value:function hasMultipleSelection(){return!!this.getSelection().getSelectionCount()}},{key:"clickCopyMultipleButton",value:function clickCopyMultipleButton(e){var _$$offset=$(e.target).offset();var left=_$$offset.left;var top=_$$offset.top;top+=e.target.offsetHeight;var copyToTargets=this.getTargetsForAction(this.getSelection().getSelectedItems(),this.copyBlockMenuAction);app.contextMenu.show(left,top,copyToTargets)}},{key:"clickMoveMultipleButton",value:function clickMoveMultipleButton(e){var _$$offset2=$(e.target).offset();var left=_$$offset2.left;var top=_$$offset2.top;top+=e.target.offsetHeight;var moveToTargets=this.getTargetsForAction(this.getSelection().getSelectedItems(),this.moveBlockMenuAction);app.contextMenu.show(left,top,moveToTargets)}},{key:"clickDuplicateMultipleButton",value:function clickDuplicateMultipleButton(e){this.duplicateBlockMenuAction(this.getSelection().getSelectedItems())}},{key:"clickDeleteMultipleButton",value:function clickDeleteMultipleButton(e){this.deleteBlockMenuAction(this.getSelection().getSelectedItems())}},{key:"clickToggleMultipleButton",value:function clickToggleMultipleButton(e){var button=$(e.target).closest(".toggle");var enable=button.data("enable");this.toggleBlockMenuAction(this.getSelection().getSelectedItems(),enable)}},{key:"clickCreateStyleButton",value:function clickCreateStyleButton(){this.createNewBlock(app.context.page.getFocusedNode())}},{key:"createNewBlock",value:function createNewBlock(){var node=arguments.length<=0||arguments[0]===undefined?null:arguments[0];var afterInsert=arguments.length<=1||arguments[1]===undefined?null:arguments[1];var defaultSelector="";if(node){var systemSelector="";if(app.context.page.getFocusedNode()==app.context.page.getFocusedComponent().element[0]){var systemBlocks=app.context.page.getFocusedComponent().getMatchingSystemCSS({ignorePseudoAndState:true});systemBlocks=systemBlocks.filter(function(b){return b.selector[0]!="*"});if(systemBlocks.length){systemSelector=systemBlocks[0].selector}}var generatedSelector=prettyDOMNodeName(node);if(compareSelectorSpecificity(systemSelector,generatedSelector)<1){defaultSelector=systemSelector}else{defaultSelector=generatedSelector}}var block=new CSSBlock(defaultSelector);var cssResource=this.getTargetCSSResource();if(!cssResource){cssResource=app.getPanel("design").createNewCSSFile();this.targetCSSResource=cssResource}var index=cssResource.blocks.length;this.focusNewBlockSelector(block,index,afterInsert);this.update()}},{key:"clickCreateChooseStyleButton",value:function clickCreateChooseStyleButton(e){var options=[];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=app.context.assets.css.getLocalCSSResources()[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var css=_step2.value;options.push({name:app.context.assets.css.getRelativePathForItem(css),action:styleClick.bind(this,css)})}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2["return"]){_iterator2["return"]()}}finally{if(_didIteratorError2){throw _iteratorError2}}}options.push({name:"New Stylesheet",action:function action(){var style=app.getPanel("design").createNewCSSFile();styleClick(style)}});var rect=e.target.getBoundingClientRect();app.contextMenu.show(rect.right-10,rect.bottom-10,options);var that=this;function styleClick(stylesheet){that.targetCSSResource=stylesheet;that.clickCreateStyleButton()}}},{key:"clickSearchButton",value:function clickSearchButton(){this.searchButton.hide();this.searchInput.show().focus()}},{key:"focusoutSearchInput",value:function focusoutSearchInput(){if(this.searchInput.val().trim().length)return;this.searchButton.show();this.searchInput.hide()}},{key:"inputSearchInput",value:function inputSearchInput(){var val=this.searchInput.val();if(val){this.searchRegex=new RegExp(escapeRegexString(val),"ig")}else{this.searchRegex=null}this.resultIndex=0;this.resultHighlightID=null;this.scheduleUpdate(100,{scrollToSearchResult:true})}},{key:"keydownSearchInput",value:function keydownSearchInput(e){if(e.which==27){this.cancelSearch();this.scheduleUpdate()}if(e.which==13||e.which==114){var totalMatches=this.element[0].querySelectorAll(".search-match").length;if(!totalMatches){this.resultIndex=0;return}if(e.shiftKey){this.resultIndex--;if(this.resultIndex<0){this.resultIndex=totalMatches-1}}else{this.resultIndex++;if(this.resultIndex>=totalMatches){this.resultIndex=0}}this.updateSearch(true)}if(keyChecker(e.which==70&&e.ctrlKey,e.which==70&&e.metaKey)){this.searchInput[0].select()}}},{key:"cancelSearch",value:function cancelSearch(){this.searchRegex=null;this.resultIndex=0;this.resultHighlightID=null;this.searchButton.css("display","inline-block");this.searchInput.val("").hide();this.numberResults.hide()}},{key:"clickCSSBlock",value:function clickCSSBlock(e){var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(isSelectionClick(e)){if(block.isInKeyframes()){block=block.getParentKeyframes();e.stopImmediatePropagation()}if(block.canBeSelected()){this.cancelSearch();this.resetFocus();this.getSelection().click(block,e);this.update()}}else{if(this.hasMultipleSelection()){this.clearSelection();this.update()}}}},{key:"clickCSSProperty",value:function clickCSSProperty(e){e.stopImmediatePropagation();var li=e.currentTarget.parentNode;var rule=this.domToCSSItem.get(li);if(this.isCSSPropertyFocused(rule))return;e.preventDefault();var block=this.domToCSSItem.get(li.closest(".css-block"));if(!rule||!block)return;this.handlePendingChanges();this.stopAnimations();this.refreshPreviouslyFocusedBlock();this.focusCSSProperty(block,rule);this.refreshBlock(block)}},{key:"clickCSSValue",value:function clickCSSValue(e){e.stopImmediatePropagation();var li=e.currentTarget.parentNode;var rule=this.domToCSSItem.get(li);if(this.isCSSValueFocused(rule))return;e.preventDefault();var block=this.domToCSSItem.get(li.closest(".css-block"));if(!rule||!block)return;this.handlePendingChanges();this.stopAnimations();this.refreshPreviouslyFocusedBlock();this.focusCSSValue(block,rule);this.refreshBlock(block)}},{key:"clickSelector",value:function clickSelector(e){e.stopImmediatePropagation();var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(!block)return;if(block instanceof CSSBlockStyle)return;if(this.isSelectorFocused(block))return;e.preventDefault();this.handlePendingChanges();this.stopAnimations();this.refreshPreviouslyFocusedBlock();this.focusBlockSelector(block);this.refreshBlock(block)}},{key:"clickKeyframesName",value:function clickKeyframesName(e){e.stopImmediatePropagation();var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(!block)return;if(this.isKeyframesNameFocused(block))return;e.preventDefault();this.handlePendingChanges();this.stopAnimations();this.refreshPreviouslyFocusedBlock();this.focusKeyframesName(block);this.refreshBlock(block)}},{key:"clickMediaQuery",value:function clickMediaQuery(e){e.stopImmediatePropagation();var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(!block)return;if(this.isMediaQueryFocused(block))return;e.preventDefault();this.handlePendingChanges();this.stopAnimations();this.refreshPreviouslyFocusedBlock();this.focusBlockMediaQuery(block);this.refreshBlock(block)}},{key:"clickOrigin",value:function clickOrigin(e){e.stopImmediatePropagation();e.preventDefault();var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(!block)return;if(this.isMediaQueryFocused(block))return;this.handlePendingChanges();this.refreshPreviouslyFocusedBlock();this.refreshBlock(block);var res=app.context.findResourceForCSSBlock(block);if(res){var editor=app.editorPanel.openForEditing(res);setTimeout(function(){editor.scrollToBlock(block)},50)}}},{key:"colorClick",value:function colorClick(e){this.resetFocus();this.update();this.resetPendingChanges();var that=this;var li=e.currentTarget.closest("li");var rule=this.domToCSSItem.get(li);var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));var before=rule.value.slice(0,e.currentTarget.dataset.start),after=rule.value.slice(e.currentTarget.dataset.end);app.colorPicker.open({color:e.currentTarget.dataset.color,point:app.mousePosition,onChange:function onChange(color){that.setPendingChanges(before+color+after,{block:block,rule:rule,type:"value"});var tempRule=rule.clone();tempRule.value=before+color+after;var oldLi=li;li=that.renderRule(tempRule);$(oldLi).replaceWith(li)},onSelect:function onSelect(color){that.resetPendingChanges();that.updateRule(block,rule,rule.property,before+color+after);that.refreshBlock(block)},onCancel:function onCancel(){that.resetPendingChanges();that.refreshBlock(block)}});e.preventDefault();return false}},{key:"clickTempBlock",value:function clickTempBlock(e){if(this.focus.type!="new-selector")return;if(e.target.closest(".selector"))return;e.stopImmediatePropagation();e.preventDefault();this.handleNext(e.currentTarget.querySelector(".selector").textContent)}},{key:"clickOpeningBrace",value:function clickOpeningBrace(e){if(hasSelection())return;if(!e.target.matches(".opening-brace"))return;e.stopImmediatePropagation();e.preventDefault();var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(!block)return;if(block instanceof CSSKeyframes){var newBlock=new CSSBlock("");newBlock.setInKeyframes(block);this.focusKeyframesNewBlockSelector(newBlock,block,0);this.refreshBlock(block)}else{this.focusNewCSSProperty(block,new CSSRule,0);this.refreshBlock(block)}}},{key:"clickClosingBrace",value:function clickClosingBrace(e){if(hasSelection())return;e.stopImmediatePropagation();e.preventDefault();var block=this.domToCSSItem.get(e.currentTarget.closest(".css-block"));if(!block)return;if(block instanceof CSSKeyframes){var newBlock=new CSSBlock("");newBlock.setInKeyframes(block);this.focusKeyframesNewBlockSelector(newBlock,block,block.blocks.length);this.refreshBlock(block)}else if(block.isInKeyframes()){var keyframes=block.getParentKeyframes();var index=keyframes.blockIndex(block)+1;var newBlock=new CSSBlock("");newBlock.setInKeyframes(keyframes);this.focusKeyframesNewBlockSelector(newBlock,keyframes,index);this.refreshBlock(keyframes)}else{var rule=new CSSRule;this.focusNewCSSProperty(block,rule,block.rules.length);this.refreshBlock(block)}}},{key:"clickCSSRule",value:function clickCSSRule(e){if(hasSelection())return;if(!e.target.matches("li"))return;e.stopImmediatePropagation();e.preventDefault();var li=e.currentTarget;var rule=this.domToCSSItem.get(li);var block=this.domToCSSItem.get(li.closest(".css-block"));if(!rule||!block)return;var index=block.rules.indexOf(rule);if(index==-1)return;this.focusNewCSSProperty(block,new CSSRule,index+1);this.refreshBlock(block)}},{key:"clickPlayButton",value:function clickPlayButton(e){var li=e.target.parentNode;var block=this.domToCSSItem.get(li.closest(".css-block"));if(e.target.classList.contains("active")){this.stopAnimations()}else{this.stopAnimations();e.target.classList.add("active");this.startAnimation(block)}}},{key:"checkBoxChange",value:function checkBoxChange(e){e.stopImmediatePropagation();var li=e.target.closest("li");var rule=this.domToCSSItem.get(li);var block=this.domToCSSItem.get(li.closest(".css-block"));this.toggleRule(block,rule);this.refreshRule(rule)}},{key:"mouseenterSelector",value:function mouseenterSelector(e){var cssBlock=e.target.closest(".css-block");var block=this.domToCSSItem.get(cssBlock);if(!block||cssBlock.querySelector("[contenteditable]")){return}if(!block.canBeHighlighted()){return}this._matchSelectorTimeout=setTimeout(function(){app.canvas.highlightCSSSelector(block.selector)},150)}},{key:"mouseleaveSelector",value:function mouseleaveSelector(){clearTimeout(this._matchSelectorTimeout);app.canvas.removeCSSSelectorHighlight()}},{key:"clearSelection",value:function clearSelection(){this.multipleSelection=null}},{key:"onCopy",value:function onCopy(e){if(!hasSelection())return;var range=window.getSelection().getRangeAt(0);var ancestor=range.commonAncestorContainer;var blacklist=".css-block .rules, .css-block .selector, "+".css-block .media, .css-block.keyframes .css-block";if(!ancestor||!ancestor.matches||ancestor.matches(blacklist)||ancestor.closest(blacklist)){return}var selection="";var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.cssBlocks[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var block=_step3.value;var node=this.cssItemToDOM.get(block);if(!node)continue;if(range.intersectsNode(node)){var tmp=block.clone();tmp.enabled=true;selection+=tmp.toString()+"\n"}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3["return"]){_iterator3["return"]()}}finally{if(_didIteratorError3){throw _iteratorError3}}}if(selection){
e.originalEvent.clipboardData.setData("text/plain",selection);e.preventDefault()}}},{key:"onEditableKeydown",value:function onEditableKeydown(e){if(e.which==38||e.which==40){var direction=e.which==38?1:-1;if(/\d+/.test(e.target.textContent)){var pos=saveRestoreCaret.save();var oldLength=e.target.textContent.length;var caretOffset=window.getSelection().anchorOffset;e.target.textContent=e.target.textContent.replace(/(-\d+\.\d+|\d+\.\d+|-\d+|\d+)(?:vw|vh|vmin|vmax|px|pt|pc|ex|em|rem|ch|cm|mm|in|deg|\b)\b/g,function(match,num,offset){if(caretOffset<offset||caretOffset>offset+match.length){return match}var numb=Number(num)+direction;var suffix=match.replace(num,"");if(e.ctrlKey){numb=Number(num)+direction*100}else if(e.shiftKey){numb=Number(num)+direction*10}else if(e.altKey){numb=(Number(num)*10+direction)/10}if(numb!=Math.round(numb)){return numb.toFixed(1)+suffix}return numb+suffix});var newLength=e.target.textContent.length;this.setPendingChanges(e.target.textContent,this.focus);saveRestoreCaret.restore(e.target.firstChild,pos,newLength-oldLength);e.preventDefault()}}if(e.which==13){e.preventDefault();this.handleNext(e.target.textContent)}if(e.which==9){e.preventDefault();if(e.shiftKey){this.handlePrevious(e.target.textContent)}else{this.handleNext(e.target.textContent)}}if(e.which==27){this.ignoreFocusoutForABit();this.resetFocus();this.update();this.resetPendingChanges()}if(e.which==8&&this.focus.type=="new-value"&&e.target.textContent==""){e.preventDefault();this.handlePrevious("")}}},{key:"onEditablePaste",value:function onEditablePaste(e){e.preventDefault();var value=e.originalEvent.clipboardData.getData("Text");insertAtCaret(e.target,value);this.onEditableInput(e)}},{key:"onEditableInput",value:function onEditableInput(e){var focus=this.focus||{};var block=focus.block,rule=focus.rule,type=focus.type;var pos=saveRestoreCaret.save();e.target.textContent=e.target.textContent;saveRestoreCaret.restore(e.target.firstChild,pos);this.setPendingChanges(e.target.textContent,focus);if(type=="selector"||type=="new-selector"||type=="keyframes-new-selector"){if(e.target.textContent.trim().match(/\{[\s\S]+\}$/)){var cssBlocks=null;var keyframes=block.getParentKeyframes();try{cssBlocks=parseCSS(e.target.textContent);if(block.isInKeyframes()){cssBlocks=cssBlocks.filter(function(b){return!(b instanceof CSSKeyframes)});cssBlocks.forEach(function(b){return b.setInKeyframes(keyframes)})}}catch(e){this.resetFocus();this.refreshBlock(block);return}if(cssBlocks.length){e.target.textContent="";this.resetPendingChanges();var that=this;setTimeout(function(){if(block.isInKeyframes()){that.insertKeyframesBlocks(keyframes,cssBlocks,focus.index)}else{that.insertBlocks(cssBlocks,focus.index)}if(that.mode=="css-editor"){var lastBlock=cssBlocks[cssBlocks.length-1];that.focusCSSValue(lastBlock,lastBlock.rules[lastBlock.rules.length-1])}else{that.resetFocus()}that.update()},20)}}if(e.target.textContent.match(/\{\s*$/)){return this.handleNext(e.target.textContent.trim().slice(0,-1))}}if(type=="property"||type=="new-property"){if(e.target.textContent.match(/\:\s*$/)){return this.handleNext(e.target.textContent.trim().slice(0,-1))}var rules=quickParseCSSRules(e.target.textContent);if(rules.length){e.target.textContent="";this.resetPendingChanges();var that=this;setTimeout(function(){var index=focus.index;if(type=="property"){index=block.rules.indexOf(rule);that.deleteRule(block,rule)}that.insertRules(block,rules,index);that.focusNewCSSProperty(block,new CSSRule,index+rules.length);that.refreshBlock(block)},20)}}if(type=="value"||type=="new-value"){if(e.target.textContent.match(/\;\s*$/)){return this.handleNext(e.target.textContent.trim().slice(0,-1))}}}},{key:"onEditableFocus",value:function onEditableFocus(e){if(app.shouldCloseContextMenu(e.target)){app.contextMenu.hide()}var block=this.domToCSSItem.get(e.target.closest(".css-block"));if(!block)return;if(this.focusOutTimeout){clearTimeout(this.focusOutTimeout)}this.resetPendingChanges();var focus=this.focus||{},rule=focus.rule;var that=this;if(focus.type=="property"||focus.type=="new-property"){this.activeTooltip=new SuggestionTooltip($(e.target),{condition:/^([\w-]+)$/i,items:cssProperties.validProperties},{onSelect:function onSelect(val,method){if(method=="enter"||method=="click"){that.handleNext(val)}}})}if(focus.type=="value"||focus.type=="new-value"){if(cssProperties.validProperties.indexOf(rule.property)==-1){return}var cssPropertySuggestions=["initial","inherit"];if(cssProperties.propertyValues.hasOwnProperty(rule.property.toLowerCase())){cssPropertySuggestions=cssPropertySuggestions.concat(cssProperties.propertyValues[rule.property.toLowerCase()])}if(rule.property.toLowerCase()=="font-family"){Array.prototype.unshift.apply(cssPropertySuggestions,app.context.getFonts().map(function(f){return"'"+f.name+"'"}))}if(rule.property.toLowerCase()=="animation"||rule.property.toLowerCase()=="animation-name"){Array.prototype.unshift.apply(cssPropertySuggestions,app.context.assets.css.getAllKeyframeAnimationNames())}this.activeTooltip=new SuggestionTooltip($(e.target),[{condition:/^([\w-]*)$/i,items:cssPropertySuggestions},{condition:/url\(['"]?([\w-\.]*)$/i,items:function items(){return app.context.assets.images.getAll().map(function(i){return app.context.assets.images.getRelativePathForItem(i)})}}],{onSelect:function onSelect(val,method){if((method=="enter"||method=="click")&&cssProperties.singleValueProperties.includes(rule.property.toLowerCase())&&!val.match(/url\(/)){that.handleNext(val)}else{that.setPendingChanges(val,focus)}},onPreview:function onPreview(val){that.setPreview(val,focus)}});if(e.target.textContent.trim().length==0){this.activeTooltip.update()}}}},{key:"onEditableFocusout",value:function onEditableFocusout(e){if(this.activeTooltip){this.activeTooltip.destroy();this.activeTooltip=null}if(this.ignoreFocusout)return;if(this.focusOutTimeout){clearTimeout(this.focusOutTimeout)}var that=this;this.focusOutTimeout=setTimeout(function(){if(that.focus&&that.focus.type=="new-selector"&&e.target.textContent.trim()){that.commitFieldChanges(e.target.textContent.trim(),that.focus);that.resetPendingChanges()}else{that.handlePendingChanges()}that.resetFocus();that.update()},20)}},{key:"ignoreFocusoutForABit",value:function ignoreFocusoutForABit(){var _this=this;this.ignoreFocusout=true;setTimeout(function(){_this.ignoreFocusout=false},50)}},{key:"isBlockSelected",value:function isBlockSelected(block){return this.getSelection().isItemSelected(block)}},{key:"isRuleFocused",value:function isRuleFocused(rule){return this.focus&&this.focus.rule==rule}},{key:"isCSSPropertyFocused",value:function isCSSPropertyFocused(rule){return this.isRuleFocused(rule)&&(this.focus.type=="property"||this.focus.type=="new-property")}},{key:"isCSSValueFocused",value:function isCSSValueFocused(rule){return this.isRuleFocused(rule)&&(this.focus.type=="value"||this.focus.type=="new-value")}},{key:"isBlockFocused",value:function isBlockFocused(block){return this.focus&&this.focus.block==block}},{key:"isSelectorFocused",value:function isSelectorFocused(block){return this.isBlockFocused(block)&&(this.focus.type=="selector"||this.focus.type=="new-selector")}},{key:"isMediaQueryFocused",value:function isMediaQueryFocused(block){return this.isBlockFocused(block)&&this.focus.type=="mediaquery"}},{key:"isKeyframesNameFocused",value:function isKeyframesNameFocused(block){return this.isBlockFocused(block)&&this.focus.type=="keyframes-name"}},{key:"hasFocus",value:function hasFocus(){return!!this.focus}},{key:"focusBlock",value:function focusBlock(block){if(block instanceof CSSKeyframes){return this.focusKeyframesName(block)}if(block instanceof CSSBlockStyle){return this.resetFocus()}return this.focusBlockSelector(block)}},{key:"focusBlockSelector",value:function focusBlockSelector(block){var resource=app.context.findResourceForCSSBlock(block);var index=resource.findIndexForCSSBlock(block);this.focus={block:block,type:"selector",index:index}}},{key:"focusKeyframesName",value:function focusKeyframesName(block){this.focus={block:block,type:"keyframes-name"}}},{key:"focusNewBlockSelector",value:function focusNewBlockSelector(block,index){var afterInsert=arguments.length<=2||arguments[2]===undefined?null:arguments[2];this.focus={block:block,type:"new-selector",index:index,afterInsert:afterInsert}}},{key:"focusKeyframesNewBlockSelector",value:function focusKeyframesNewBlockSelector(block,keyframes,index){this.focus={block:block,keyframes:keyframes,type:"keyframes-new-selector",index:index}}},{key:"focusBlockMediaQuery",value:function focusBlockMediaQuery(block){this.focus={block:block,type:"mediaquery"}}},{key:"focusCSSProperty",value:function focusCSSProperty(block,rule){this.focus={block:block,rule:rule,type:"property"}}},{key:"focusCSSValue",value:function focusCSSValue(block,rule){this.focus={block:block,rule:rule,type:"value"}}},{key:"focusNewCSSProperty",value:function focusNewCSSProperty(block,rule,index){this.focus={block:block,rule:rule,type:"new-property",index:index}}},{key:"focusNewCSSValue",value:function focusNewCSSValue(block,rule,index){this.focus={block:block,rule:rule,type:"new-value",index:index}}},{key:"resetFocus",value:function resetFocus(){this.focus=null}},{key:"startAnimation",value:function startAnimation(cssBlock){if(cssBlock instanceof CSSKeyframes||cssBlock.isInKeyframes()){return}if(cssBlock instanceof CSSBlockStyle){if(!this._originalAnimationBlock){this._originalAnimationBlock=cssBlock}cssBlock.previewNodeStyle({skipAnimationProperties:false});app.canvas.setCSSOverride("")}else{var css=app.context.prepareCSSOverrideString(cssBlock.toString({skipAnimationProperties:false}));app.canvas.setCSSOverride(css)}this.animationsRunning=true}},{key:"stopAnimations",value:function stopAnimations(){if(!this.animationsRunning){return}this.animationsRunning=false;if(this._originalAnimationBlock&&this._originalAnimationBlock instanceof CSSBlockStyle){this._originalAnimationBlock.previewNodeStyle({skipAnimationProperties:true});delete this._originalAnimationBlock}this._originalAnimationBlock=null;app.canvas.resetCSSOverride();this.element.find(".play-button.active").removeClass("active")}},{key:"setPendingChanges",value:function setPendingChanges(value,pointer){if(!pointer.block||pointer.block instanceof CSSKeyframes||pointer.block.isInKeyframes()){return}this.pending={value:value,pointer:pointer};this.setPreview(value,pointer)}},{key:"resetPendingChanges",value:function resetPendingChanges(){this.pending=null;this.resetPreview();app.canvas.removeCSSSelectorHighlight()}},{key:"handlePendingChanges",value:function handlePendingChanges(){if(!this.pending){this.resetPreview();return}var pending=this.pending;this.resetPendingChanges();this.commitFieldChanges(pending.value,pending.pointer)}},{key:"setPreview",value:function setPreview(value,pointer){if(pointer.block instanceof CSSKeyframes||pointer.block.isInKeyframes()){return}var tmpRule;if(pointer.type=="property"||pointer.type=="new-property"){tmpRule=pointer.rule.clone();tmpRule.property=value}if(pointer.type=="value"||pointer.type=="new-value"){tmpRule=pointer.rule.clone();tmpRule.value=value}if(!tmpRule||!tmpRule.isValid())return;var tmpBlock=pointer.block.clone();if(pointer.index!=null){tmpBlock.rules.splice(pointer.index,0,tmpRule)}else{tmpBlock.rules.splice(pointer.block.rules.indexOf(pointer.rule),1,tmpRule)}if(!(pointer.block instanceof CSSBlockStyle)){tmpBlock.removeUnrelatedRules(tmpRule.property)}this.previewControl=tmpBlock.previewControl({skipAnimationProperties:!tmpRule.isAnimationControl()});this.previewControl.set()}},{key:"resetPreview",value:function resetPreview(){if(this.previewControl){this.previewControl.clear()}this.previewControl=null}},{key:"refreshPreviouslyFocusedBlock",value:function refreshPreviouslyFocusedBlock(){if(!this.focus)return;var oldBlock=this.focus.block;var that=this;setTimeout(function(){if(that.focus&&oldBlock!==that.focus.block){that.refreshBlock(oldBlock)}},10)}},{key:"commitFieldChanges",value:function commitFieldChanges(val,pointer){val=val.trim();var block=pointer.block,rule=pointer.rule;switch(pointer.type){case"selector":if(val.length){this.updateSelector(block,val)}else{this.deleteBlock(block)}break;case"new-selector":if(val.length){block.selector=val;this.insertBlock(block,pointer.index);if(pointer.afterInsert){pointer.afterInsert(block)}}break;case"mediaquery":if(val.length){this.updateMediaQuery(block,val)}else{this.updateMediaQuery(block,false)}break;case"property":if(val.length){this.updateRule(block,rule,val,rule.value)}else{this.deleteRule(block,rule)}break;case"new-property":break;case"value":if(val.length){this.updateRule(block,rule,rule.property,val)}else{this.deleteRule(block,rule)}break;case"new-value":if(val.length){rule.value=val;this.insertRule(block,rule,pointer.index)}else{this.deleteRule(block,rule)}break}}},{key:"handleNext",value:function handleNext(){var val=arguments.length<=0||arguments[0]===undefined?"":arguments[0];this.ignoreFocusoutForABit();this.resetPendingChanges();val=val.trim();var block=this.focus.block,rule=this.focus.rule;switch(this.focus.type){case"selector":if(val.length){this.updateSelector(block,val);if(block.rules.length){this.focusCSSProperty(block,block.rules[0])}else{var rule=new CSSRule;this.focusNewCSSProperty(block,rule,0)}this.refreshBlock(block)}else{var nextBlock=this.getNextBlock(block);this.deleteBlock(block);if(nextBlock){this.focusBlock(nextBlock)}else{this.resetFocus()}this.update()}break;case"new-selector":if(val.length){if(val.match(/^@keyframes/i)){var keyframes=new CSSKeyframes(val.replace(/@keyframes/i,"").trim());this.insertBlock(keyframes,this.focus.index);var newBlock=new CSSBlock("");newBlock.setInKeyframes(keyframes);this.focusKeyframesNewBlockSelector(newBlock,keyframes,0);this.replaceBlock(block,keyframes)}else{block.selector=val;this.insertBlock(block,this.focus.index);if(this.focus.afterInsert){this.focus.afterInsert(block)}this.focusNewCSSProperty(block,new CSSRule,0);this.refreshBlock(block)}}else{this.resetFocus();this.update()}break;case"keyframes-new-selector":var keyframes=this.focus.keyframes;if(val.length){block.selector=val;this.insertKeyframesBlock(keyframes,block,this.focus.index);this.focusNewCSSProperty(block,new CSSRule,0);this.refreshBlock(keyframes)}else{var nextBlock=null;if(keyframes.blocks.length==this.focus.index){nextBlock=this.getNextBlock(keyframes)}if(nextBlock){this.focusBlock(nextBlock)}else{this.resetFocus()}this.update()}break;case"keyframes-name":if(val.length){var keyframes=block;this.updateKeyframesName(keyframes,val);if(keyframes.hasBlocks()){var nextBlock=keyframes.blocks[0];this.focusBlock(nextBlock)}else{var newBlock=new CSSBlock("");newBlock.setInKeyframes(keyframes);this.focusKeyframesNewBlockSelector(newBlock,keyframes,0)}this.refreshBlock(keyframes)}else{var nextBlock=this.getNextBlock(block);this.deleteBlock(block);if(nextBlock){this.focusBlock(nextBlock)}else{this.resetFocus()}this.update()}break;case"mediaquery":if(val.length){this.updateMediaQuery(block,val)}else{this.updateMediaQuery(block,false)}this.resetFocus();this.refreshBlock(block);break;case"property":if(val.length){this.updateRule(block,rule,val,rule.value);this.focusCSSValue(block,rule)}else{var nextRule=this.getNextRule(block,rule);var previousRule=this.getPreviousRule(block,rule);this.deleteRule(block,rule);if(nextRule){this.focusCSSProperty(block,nextRule)}else if(previousRule){this.focusCSSProperty(block,previousRule)}else{this.resetFocus();this.update();return}}this.refreshBlock(block);break;case"new-property":if(val.length){rule.property=val;this.focusNewCSSValue(block,rule,this.focus.index)}else{var nextRule=null;if(this.focus.index==0){nextRule=block.rules[0]}else{nextRule=this.getNextRule(block,this.focus.index-1)}var nextBlock=this.getNextBlock(block);if(nextRule){this.focusCSSProperty(block,nextRule)}else if(block.isInKeyframes()&&!block.getParentKeyframes().hasNextBlock(block)){var keyframes=block.getParentKeyframes();var newBlock=new CSSBlock("");newBlock.setInKeyframes(keyframes);this.focusKeyframesNewBlockSelector(newBlock,keyframes,keyframes.blocks.length);return this.refreshBlock(keyframes)}else if(nextBlock){this.focusBlock(nextBlock);this.refreshBlock(nextBlock)}else{this.resetFocus();this.update();return}}this.refreshBlock(block);break;case"value":var ruleIndex=block.rules.indexOf(rule);if(val.length){this.updateRule(block,rule,rule.property,val);ruleIndex++}else{this.deleteRule(block,rule)}var nextRule=this.getNextRule(block,rule);if(nextRule){this.focusCSSProperty(block,nextRule)}else{this.focusNewCSSProperty(block,new CSSRule,ruleIndex)}this.refreshBlock(block);break;case"new-value":var index=this.focus.index;var nextRule;if(val.length){rule.value=val;this.insertRule(block,rule,this.focus.index);nextRule=this.getNextRule(block,rule);index++}else{nextRule=block.rules[index]}if(nextRule){this.focusCSSProperty(block,nextRule)}else{var rule=new CSSRule;this.focusNewCSSProperty(block,rule,index)}this.refreshBlock(block);break}}},{key:"handlePrevious",value:function handlePrevious(){var val=arguments.length<=0||arguments[0]===undefined?"":arguments[0];this.ignoreFocusoutForABit();this.resetPendingChanges();val=val.trim();var block=this.focus.block,rule=this.focus.rule;switch(this.focus.type){case"selector":case"keyframes-name":var previousBlock=this.getPreviousBlock(block);if(previousBlock instanceof CSSKeyframes&&previousBlock.blocks.length){previousBlock=previousBlock.blocks[previousBlock.blocks.length-1]}if(this.focus.type=="keyframes-name"){if(val.length){this.updateKeyframesName(block,val)}else{this.deleteBlock(block)}}else{if(block.isInKeyframes()&&block.getParentKeyframes().blockIndex(block)==0){previousBlock=block.getParentKeyframes()}if(val.length){this.updateSelector(block,val)}else{this.deleteBlock(block)}}if(previousBlock){if(previousBlock.rules.length){this.focusCSSValue(previousBlock,previousBlock.rules[previousBlock.rules.length-1])}else if(previousBlock instanceof CSSBlockStyle){this.resetFocus()}else{this.focusBlock(previousBlock)}this.refreshBlock(previousBlock)}else{this.resetFocus()}if(val.length){this.refreshBlock(block)}else{this.update()}break;case"new-selector":if(val.length){block.selector=val;this.insertBlock(block,this.focus.index);if(this.focus.afterInsert){this.focus.afterInsert(block)}this.resetFocus();this.refreshBlock(block)}else{this.resetFocus();this.update()}break;case"keyframes-new-selector":var keyframes=this.focus.keyframes;if(val.length){block.selector=val;this.insertKeyframesBlock(keyframes,block,this.focus.index);this.resetFocus();this.refreshBlock(keyframes)}else{this.resetFocus();this.update()}break;case"mediaquery":if(val.length){this.updateMediaQuery(block,val)}else{this.updateMediaQuery(block,false)}this.resetFocus();this.refreshBlock(block);break;case"property":var previousRule=this.getPreviousRule(block,rule);if(val.length){this.updateRule(block,rule,val,rule.value)}else{this.deleteRule(block,rule)}if(previousRule){this.focusCSSValue(block,previousRule)}else if(block instanceof CSSBlockStyle){this.resetFocus()}else{this.focusBlock(block)}this.refreshBlock(block);break;case"new-property":if(val.length){rule.property=val;if(rule.value.trim().length){this.insertRule(block,rule,this.focus.index)}}var previousRule=this.getPreviousRule(block,this.focus.index);if(previousRule){this.focusCSSValue(block,previousRule)}else if(block instanceof CSSBlockStyle){this.resetFocus()}else{this.focusBlock(block)}this.refreshBlock(block);break;case"value":if(val.length){this.updateRule(block,rule,rule.property,val);this.focusCSSProperty(block,rule)}else{var previousRule=this.getPreviousRule(block,rule);if(previousRule){this.focusCSSValue(block,previousRule)}else{this.focusBlock(block)}this.deleteRule(block,rule)}this.refreshBlock(block);break;case"new-value":rule.value=val;if(val.length){this.insertRule(block,rule,this.focus.index);this.focusCSSProperty(block,rule)}else{this.focusNewCSSProperty(block,rule,this.focus.index)}this.refreshBlock(block);break}}},{key:"getNextRule",value:function getNextRule(block,current){var index=current;if(current instanceof CSSRule){index=block.rules.indexOf(current)}if(index<0)return null;if(block.rules[index+1])return block.rules[index+1];return null}},{key:"getPreviousRule",value:function getPreviousRule(block,current){var index=current;if(current instanceof CSSRule){index=block.rules.indexOf(current)}if(index>0)return block.rules[index-1];return null}},{key:"getNextBlock",value:function getNextBlock(block){var nextBlock=null;if(block.isInKeyframes()){nextBlock=block.getParentKeyframes().getNextBlock(block);if(!nextBlock)nextBlock=this.getNextBlock(block.getParentKeyframes())}if(!nextBlock){var index=this.cssBlocks.indexOf(block);if(index==-1)return null;nextBlock=this.cssBlocks[index+1]}if(!nextBlock)return null;if(nextBlock.isLocked()){return this.getNextBlock(nextBlock)}return nextBlock}},{key:"getPreviousBlock",value:function getPreviousBlock(block){var previousBlock=null;if(block.isInKeyframes()){previousBlock=block.getParentKeyframes().getPreviousBlock(block);if(!previousBlock)previousBlock=this.getPreviousBlock(block.getParentKeyframes())}if(!previousBlock){var index=this.cssBlocks.indexOf(block);if(index<1)return null;previousBlock=this.cssBlocks[index-1]}if(!previousBlock)return null;if(previousBlock.isLocked()){return this.getPreviousBlock(previousBlock)}return previousBlock}},{key:"insertRules",value:function insertRules(block,rules,index){var history=arguments.length<=3||arguments[3]===undefined?"Add CSS Rules":arguments[3];var oldRules=block.rules.slice();block.addAtIndex(rules,index);var newRules=block.rules.slice();var context=app.context;if(block instanceof CSSBlockStyle){this.ignoreUpdatedEvent=true;block.setNodeStyle();block.component.update();this.ignoreUpdatedEvent=false;context.history.add({name:history,undo:function undo(){block.rules=oldRules;block.setNodeStyle();block.component.update()},redo:function redo(){block.rules=newRules;block.setNodeStyle();block.component.update()}});return}var resource=context.assets.css.findResourceForBlock(block);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],block);this.ignoreUpdatedEvent=false;context.history.add({name:history,undo:function undo(){block.rules=oldRules;app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){block.rules=newRules;app.trigger("context-css-changed",context,[resource],block)}})}},{key:"insertRule",value:function insertRule(block,rule,index){this.insertRules(block,rule,index,"Add CSS Rule")}},{key:"updateRule",value:function updateRule(block,rule,newProperty,newValue){var oldProperty=rule.property;var oldValue=rule.value;if(newProperty==oldProperty&&newValue==oldValue)return;rule.property=newProperty;rule.value=newValue;var context=app.context;if(block instanceof CSSBlockStyle){this.ignoreUpdatedEvent=true;block.setNodeStyle();block.component.update();this.ignoreUpdatedEvent=false;context.history.add({name:"Change CSS Rule",undo:function undo(){rule.property=oldProperty;rule.value=oldValue;block.setNodeStyle();block.component.update()},redo:function redo(){rule.property=newProperty;rule.value=newValue;block.setNodeStyle();block.component.update()}});return}var resource=context.assets.css.findResourceForBlock(block);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],block);this.ignoreUpdatedEvent=false;context.history.add({name:"Change CSS Rule",undo:function undo(){rule.property=oldProperty;rule.value=oldValue;app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){rule.property=newProperty;rule.value=newValue;app.trigger("context-css-changed",context,[resource],block)}})}},{key:"deleteRule",value:function deleteRule(block,rule){var oldRules=block.rules.slice();block.removeRule(rule);var newRules=block.rules.slice();var context=app.context;if(block instanceof CSSBlockStyle){this.ignoreUpdatedEvent=true;block.setNodeStyle();block.component.update();this.ignoreUpdatedEvent=false;context.history.add({name:"Delete CSS Rule",undo:function undo(){block.rules=oldRules;block.setNodeStyle();block.component.update()},redo:function redo(){block.rules=newRules;block.setNodeStyle();block.component.update()}});return}var resource=app.context.assets.css.findResourceForBlock(block);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],block);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Delete CSS Rule",undo:function undo(){block.rules=oldRules;app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){block.rules=newRules;app.trigger("context-css-changed",context,[resource],block)}})}},{key:"insertKeyframesBlock",value:function insertKeyframesBlock(keyframes,block,index){var css=this.getTargetCSSResource();var context=app.context;keyframes.addCSSBlockAtIndex(block,index);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[css]);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Edit Keyframes Animation",undo:function undo(){keyframes.deleteCSSBlock(block);app.trigger("context-css-changed",context,[css])},redo:function redo(){keyframes.addCSSBlockAtIndex(block,index);app.trigger("context-css-changed",context,[css])}})}},{key:"insertKeyframesBlocks",value:function insertKeyframesBlocks(keyframes,blocks,index){var css=this.getTargetCSSResource();var context=app.context;var oldCSS=keyframes.blocks.slice();keyframes.addCSSBlocksAtIndex(blocks,index);var newCSS=keyframes.blocks.slice();this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[css]);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Edit Keyframes Animation",undo:function undo(){keyframes.blocks=oldCSS;app.trigger("context-css-changed",context,[css])},redo:function redo(){keyframes.blocks=newCSS;app.trigger("context-css-changed",context,[css])}})}},{key:"insertBlock",value:function insertBlock(block,index){var node=app.context.page.getFocusedNode();var css=this.getTargetCSSResource();var context=app.context;var that=this;css.addCSSBlockAtIndex(block,index);this.addModifiedBlock(node,block);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[css]);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Create CSS Block",undo:function undo(){css.deleteCSSBlock(block);that.removeModifiedBlock(node,block);app.trigger("context-css-changed",context,[css])},redo:function redo(){css.addCSSBlockAtIndex(block,index);that.addModifiedBlock(node,block);app.trigger("context-css-changed",context,[css])}})}},{key:"insertBlocks",value:function insertBlocks(blocks,index){var node=app.context.page.getFocusedNode();var css=this.getTargetCSSResource();var context=app.context;var that=this;var oldCSS=css.blocks.slice();css.addCSSBlocksAtIndex(blocks,index);blocks.forEach(function(block){return that.addModifiedBlock(node,block)});var newCSS=css.blocks.slice();this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[css]);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Create CSS Block",undo:function undo(){css.blocks=oldCSS;blocks.forEach(function(block){return that.removeModifiedBlock(node,block)});app.trigger("context-css-changed",context,[css])},redo:function redo(){css.blocks=newCSS;blocks.forEach(function(block){return that.addModifiedBlock(node,block)});app.trigger("context-css-changed",context,[css])}})}},{key:"deleteBlock",value:function deleteBlock(blocks){if(!Array.isArray(blocks)){blocks=[blocks]}return this.genericDeleteBlockAction(blocks)}},{key:"genericDeleteBlockAction",value:function genericDeleteBlockAction(blocks){var context=app.context;var that=this;var cssFiles=[];var nodes=[];blocks=blocks.filter(function(block){return!!app.context.assets.css.findResourceForBlock(block)});var node=app.context.page.getFocusedNode();var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=blocks[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var block=_step4.value;var css=app.context.assets.css.findResourceForBlock(block);var hasModBlock=this.hasModifiedBlock(node,block);var parent;if(block.isInKeyframes()){parent=block.getParentKeyframes()}else{parent=css}var index=parent.findIndexForCSSBlock(block);parent.deleteCSSBlock(block);if(hasModBlock)that.removeModifiedBlock(node,block);this.getSelection().unselectItem(block);nodes.push({node:node,index:index,parent:parent,hasModBlock:hasModBlock});cssFiles.push(css)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4["return"]){_iterator4["return"]()}}finally{if(_didIteratorError4){throw _iteratorError4}}}this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,cssFiles);this.ignoreUpdatedEvent=false;var that=this;app.context.history.add({name:"Delete CSS Block",undo:function undo(){for(var i=blocks.length-1;i>=0;i--){var block=blocks[i];var _nodes$i=nodes[i];var node=_nodes$i.node;var index=_nodes$i.index;var parent=_nodes$i.parent;var hasModBlock=_nodes$i.hasModBlock;parent.addCSSBlockAtIndex(block,index);if(hasModBlock)that.addModifiedBlock(node,block)}app.trigger("context-css-changed",context,cssFiles)},redo:function redo(){for(var i=0;i<blocks.length;i++){var block=blocks[i];var _nodes$i2=nodes[i];var node=_nodes$i2.node;var parent=_nodes$i2.parent;var hasModBlock=_nodes$i2.hasModBlock;parent.deleteCSSBlock(block);if(hasModBlock)that.removeModifiedBlock(node,block);that.getSelection().unselectItem(block)}app.trigger("context-css-changed",context,cssFiles)}})}},{key:"updateSelector",value:function updateSelector(block,newSelector){var oldSelector=block.selector;var context=app.context,resource=app.context.assets.css.findResourceForBlock(block);if(newSelector==oldSelector)return;block.selector=newSelector;this.refreshBlockMatchedSelectors(block);var that=this;this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],block);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Update CSS Selector",undo:function undo(){block.selector=oldSelector;that.refreshBlockMatchedSelectors(block);app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){block.selector=newSelector;that.refreshBlockMatchedSelectors(block);app.trigger("context-css-changed",context,[resource],block)}})}},{key:"updateKeyframesName",value:function updateKeyframesName(keyframes,newName){var oldName=keyframes.name;var context=app.context,resource=app.context.assets.css.findResourceForBlock(keyframes);if(newName==oldName)return;keyframes.name=newName;var that=this;this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],keyframes);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Update Keyframes Name",undo:function undo(){keyframes.name=oldName;app.trigger("context-css-changed",context,[resource],keyframes)},redo:function redo(){keyframes.name=newName;app.trigger("context-css-changed",context,[resource],keyframes)}})}},{key:"refreshBlockMatchedSelectors",value:function refreshBlockMatchedSelectors(block){if(this.mode!="active-styles")return;if(!app.context.page.hasFocusedNode())return;var result=block.calculateSpecificityFor(app.context.page.getFocusedNode());this.blockMatchedSelectors.set(block,result.selectors||[])}},{key:"updateMediaQuery",value:function updateMediaQuery(block,newMediaQuery){var oldMediaQuery=block.mediaQuery;var context=app.context,resource=app.context.assets.css.findResourceForBlock(block);if(newMediaQuery==oldMediaQuery)return;block.mediaQuery=newMediaQuery;this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],block);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Update Media Query",undo:function undo(){block.mediaQuery=oldMediaQuery
;app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){block.mediaQuery=newMediaQuery;app.trigger("context-css-changed",context,[resource],block)}})}},{key:"toggleRule",value:function toggleRule(block,rule){var status=arguments.length<=2||arguments[2]===undefined?"toggle":arguments[2];var oldStatus=rule.enabled;var newStatus=!oldStatus;var context=app.context;if(status!="toggle"){newStatus=status}if(newStatus==oldStatus)return;rule.enabled=newStatus;if(block instanceof CSSBlockStyle){this.ignoreUpdatedEvent=true;block.setNodeStyle();block.component.update();this.ignoreUpdatedEvent=false;context.history.add({name:"Toggle CSS Rule",undo:function undo(){rule.enabled=oldStatus;block.setNodeStyle();block.component.update()},redo:function redo(){rule.enabled=newStatus;block.setNodeStyle();block.component.update()}});return}var resource=app.context.assets.css.findResourceForBlock(block);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource],block);this.ignoreUpdatedEvent=false;context.history.add({name:"Toggle CSS Rule",undo:function undo(){rule.enabled=oldStatus;app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){rule.enabled=newStatus;app.trigger("context-css-changed",context,[resource],block)}})}},{key:"refreshBlock",value:function refreshBlock(block){var node=this.cssItemToDOM.get(block);if(!node)return;if(!(block instanceof CSSBlockStyle)&&!app.context.assets.css.findResourceForBlock(block)){if(node.parentNode)node.parentNode.removeChild(node);return}var newNode=this.renderBlock(block);$(node).replaceWith(newNode);this.focusContentEditable(newNode)}},{key:"replaceBlock",value:function replaceBlock(oldBlock,newBlock){var node=this.cssItemToDOM.get(oldBlock);if(!node)return;var newNode=this.renderBlock(newBlock);$(node).replaceWith(newNode);this.focusContentEditable(newNode)}},{key:"refreshRule",value:function refreshRule(rule){var node=this.cssItemToDOM.get(rule);if(!node)return;var newNode=this.renderRule(rule);$(node).replaceWith(newNode);this.focusContentEditable(newNode)}},{key:"focusContentEditable",value:function focusContentEditable(node){var elem=node.querySelector("[contenteditable]");if(!elem)return;elem.focus();selectElementContents(elem);elem.scrollIntoViewIfNeeded()}},{key:"scrollToBlock",value:function scrollToBlock(block){var node=this.cssItemToDOM.get(block);if(!node)return;node.scrollIntoViewIfNeeded()}},{key:"renderGroup",value:function renderGroup(group){if(!group.blocks.length){return document.createDocumentFragment()}var elem=document.createElement("div");elem.classList.add("css-group");if(group.inherited){var tmp=document.createElement("div");tmp.classList.add("inherit-label");tmp.textContent="Inherited from "+group.inheritedFrom;elem.appendChild(tmp)}if(group.keyframes){var tmp=document.createElement("div");tmp.classList.add("inherit-label");tmp.textContent="Keyframe Animations";elem.appendChild(tmp)}if(group.pseudo){var tmp=document.createElement("div");tmp.classList.add("inherit-label");tmp.textContent=":before and :after elements";elem.appendChild(tmp)}var blocks=group.blocks.map(this.renderBlock.bind(this));for(var i=0;i<blocks.length;i++){elem.appendChild(blocks[i])}this.domToCSSItem.set(elem,group);return elem}},{key:"renderBlock",value:function renderBlock(block){var elem=document.createElement("div");elem.classList.add("css-block");if(!block.isEnabled()){elem.classList.add("disabled")}var focus=this.focus||{};var showMenu=true,showRules=true,showMedia=false,showHandle=false,showOrigin=false,showSelector=true,showNestedBlocks=false,showOpeningBrace=true,showClosingBrace=true,showKeyframeName=false;var isMultipleSelectionActive=this.hasMultipleSelection(),isSelected=isMultipleSelectionActive&&this.isBlockSelected(block);var isTempBlock=false,isCurrentBlock=focus.block==block,isKeyframesBlock=block instanceof CSSKeyframes,isStyleBlock=block instanceof CSSBlockStyle;if(isCurrentBlock&&(focus.type=="keyframes-new-selector"||focus.type=="new-selector")){isTempBlock=true}showHandle=this.mode=="css-editor"&&!isTempBlock;showOrigin=this.mode=="active-styles";showMedia=!!block.mediaQuery;if(isTempBlock){elem.classList.add("temp");showMenu=false;showOrigin=false}if(isStyleBlock){elem.classList.add("style");showMenu=false;showOrigin=false}if(isKeyframesBlock){elem.classList.add("keyframes");showSelector=false;showRules=false;showNestedBlocks=true;showKeyframeName=true}if(block.isInKeyframes()){showMenu=false;showMedia=false;showHandle=false;showOrigin=false}if(block.system){elem.classList.add("system")}if(block.isLocked()){elem.classList.add("locked")}if(block.sass){showMenu=false}if(isMultipleSelectionActive){showMenu=false;showHandle=false}if(showSelector){var selector=document.createElement("span");if(isCurrentBlock&&(focus.type=="selector"||focus.type=="keyframes-new-selector"||focus.type=="new-selector")){selector.textContent=block.selector;selector.contentEditable=true;selector.spellcheck=false}else{if(this.mode=="active-styles"&&this.blockMatchedSelectors.has(block)&&!block.isInKeyframes()){selector.innerHTML=formatCSSSelector(block.selector,this.blockMatchedSelectors.get(block))}else{if(block.selector.length){selector.innerHTML="<b>"+escapeHTML(block.selector)+"</b>"}else{selector.textContent=""}}if(this.searchRegex&&this.searchRegex.test(block.selector)&&!isStyleBlock){for(var _i=0;_i<selector.childNodes.length;_i++){if(selector.childNodes[_i].nodeType==3){highlightMatches(selector.childNodes[_i],this.searchRegex,"block-"+block.runtimeID+"-sel-"+_i,this.resultHighlightID)}if(selector.childNodes[_i].tagName=="B"){highlightMatches(selector.childNodes[_i].firstChild,this.searchRegex,"block-"+block.runtimeID+"-b-sel-"+_i,this.resultHighlightID)}}}}selector.classList.add("selector")}if(showKeyframeName){var keyframesName=document.createElement("span");keyframesName.classList.add("keyframes-name");keyframesName.textContent="@keyframes ";var kfspan=document.createElement("span");keyframesName.appendChild(kfspan);kfspan.textContent=block.name;if(isCurrentBlock&&focus.type=="keyframes-name"){kfspan.contentEditable=true;kfspan.spellcheck=false}else{if(this.searchRegex&&this.searchRegex.test(block.name)){highlightMatches(kfspan.firstChild,this.searchRegex,"block-"+block.runtimeID+"-keyframes",this.resultHighlightID)}}}var header=document.createElement("div");header.classList.add("header");elem.appendChild(header);var selectorContainer=document.createElement("div");selectorContainer.classList.add("selector-container");header.appendChild(selectorContainer);if(showHandle){var handle=document.createElement("span");handle.classList.add("handle");header.appendChild(handle)}if(showMedia){var media=document.createElement("p");media.classList.add("media");media.textContent="@media ";var mSpan=document.createElement("span");mSpan.textContent=block.mediaQuery;media.appendChild(mSpan);if(focus.block==block&&focus.type=="mediaquery"){mSpan.contentEditable=true;mSpan.spellcheck=false}else{if(!block.isMediaQueryValid()){media.classList.add("error")}if(this.searchRegex&&this.searchRegex.test(block.mediaQuery)){highlightMatches(mSpan.firstChild,this.searchRegex,"block-"+block.runtimeID+"-media",this.resultHighlightID)}}selectorContainer.appendChild(media)}if(showMenu){var menu=document.createElement("div");menu.classList.add("menu");menu.innerHTML="<span></span>";header.appendChild(menu)}if(showOpeningBrace){var openingBrace=document.createElement("p");openingBrace.classList.add("opening-brace");if(showSelector){openingBrace.appendChild(selector)}if(showKeyframeName){openingBrace.appendChild(keyframesName)}openingBrace.appendChild(document.createTextNode(" {"));selectorContainer.appendChild(openingBrace)}if(showOrigin){var origin=document.createElement("div");origin.classList.add("origin");origin.textContent=block.getOrigin();if(block.isLocked()){origin.innerHTML='<i class="material-icons">lock_outline</i> '+origin.innerHTML;origin.title="Locked."}if(block.system){origin.title="Locked. Copy to edit."}elem.appendChild(origin)}if(showRules){var ul=document.createElement("ul");ul.classList.add("rules");var rules=block.rules.map(this.renderRule.bind(this));for(var i=0;i<rules.length;i++){ul.appendChild(rules[i])}elem.appendChild(ul);if(isCurrentBlock&&(focus.type=="new-value"||focus.type=="new-property")){var newRule=this.renderRule(focus.rule);newRule.classList.add("placeholder");ul.insertBefore(newRule,ul.children[focus.index])}}if(showNestedBlocks){var nested=document.createElement("div");nested.classList.add("nested");var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=block.blocks[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var bl=_step5.value;nested.appendChild(this.renderBlock(bl))}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5["return"]){_iterator5["return"]()}}finally{if(_didIteratorError5){throw _iteratorError5}}}if(isKeyframesBlock&&focus.keyframes==block&&focus.type=="keyframes-new-selector"){var newBlock=this.renderBlock(focus.block);nested.insertBefore(newBlock,nested.children[focus.index])}elem.appendChild(nested)}if(showClosingBrace){var closingBrace=document.createElement("p");closingBrace.classList.add("closing-brace");closingBrace.textContent="}";elem.appendChild(closingBrace)}if(isSelected){elem.classList.add("selected")}this.domToCSSItem.set(elem,block);this.cssItemToDOM.set(block,elem);return elem}},{key:"renderRule",value:function renderRule(rule){var focus=this.focus||{};var li=document.createElement("li");var checkbox=document.createElement("input");checkbox.type="checkbox";checkbox.tabIndex=-1;checkbox.checked=true;var propertySpan=document.createElement("span");propertySpan.textContent=rule.property;propertySpan.classList.add("css-property");var valueSpan=document.createElement("span");valueSpan.textContent=rule.value;valueSpan.classList.add("css-value");var spacer=document.createElement("i");spacer.textContent=": ";spacer.classList.add("spacer");var semi=document.createElement("span");semi.textContent=";";if(this.isRuleFocused(rule)){if(focus.type=="property"||focus.type=="new-property"){propertySpan.contentEditable=true;propertySpan.spellcheck=false}else{valueSpan.contentEditable=true;valueSpan.spellcheck=false}}else{if(rule.system){li.classList.add("system")}if(!rule.enabled){li.classList.add("disabled");checkbox.checked=false}if(!rule.isValid()){li.classList.add("error")}}if(!(this.isRuleFocused(rule)&&(focus.type=="property"||focus.type=="new-property"))&&this.searchRegex&&this.searchRegex.test(rule.property)){highlightMatches(propertySpan.firstChild,this.searchRegex,"rule-property-"+rule.runtimeID,this.resultHighlightID)}var valueNodes=[];if(valueSpan.firstChild){valueNodes.push(valueSpan.firstChild)}valueSpan.textContent="";if(!(this.isRuleFocused(rule)&&(focus.type=="value"||focus.type=="new-value"))&&rule.isColorRelated()){var matches=rule.extractColors();if(matches.length){valueNodes=[];var last=0;var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=matches[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var c=_step6.value;valueNodes.push(document.createTextNode(rule.value.slice(last,c.index)));last=c.index;var colorSpan=document.createElement("span");colorSpan.classList.add("color");colorSpan.dataset.color=c.match;colorSpan.dataset.start=c.index;colorSpan.dataset.end=c.index+c.match.length;var i=document.createElement("i");i.style.backgroundColor=c.match;colorSpan.appendChild(i);valueNodes.push(colorSpan)}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6["return"]){_iterator6["return"]()}}finally{if(_didIteratorError6){throw _iteratorError6}}}valueNodes.push(document.createTextNode(rule.value.slice(last)))}}var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=valueNodes[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var n=_step7.value;valueSpan.appendChild(n);if(!(this.isRuleFocused(rule)&&(focus.type=="value"||focus.type=="new-value"))&&this.searchRegex&&this.searchRegex.test(rule.value)){highlightMatches(n,this.searchRegex,"rule-value-"+rule.runtimeID,this.resultHighlightID)}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7["return"]){_iterator7["return"]()}}finally{if(_didIteratorError7){throw _iteratorError7}}}li.appendChild(checkbox);li.appendChild(propertySpan);li.appendChild(spacer);li.appendChild(valueSpan);li.appendChild(semi);if(!this.isRuleFocused(rule)&&rule.isAnimationControl()&&rule.isValid()){var playButton=document.createElement("b");playButton.className="play-button";li.appendChild(playButton)}this.domToCSSItem.set(li,rule);this.cssItemToDOM.set(rule,li);return li}},{key:"duplicateBlockMenuAction",value:function duplicateBlockMenuAction(blocks){if(!Array.isArray(blocks)){blocks=[blocks]}return this.genericCopyBlockToCSSResource(null,blocks,"Duplicate CSS Block"+(blocks.length!==1?"s":""))}},{key:"copyBlockMenuAction",value:function copyBlockMenuAction(resource,blocks){if(!Array.isArray(blocks)){blocks=[blocks]}return this.genericCopyBlockToCSSResource(resource,blocks,"Copy CSS Block"+(blocks.length!==1?"s":""))}},{key:"moveBlockMenuAction",value:function moveBlockMenuAction(resource,blocks){if(!Array.isArray(blocks)){blocks=[blocks]}return this.genericMoveBlockToCSSResource(resource,blocks)}},{key:"genericCopyBlockToCSSResource",value:function genericCopyBlockToCSSResource(newResource,blocks,title){var context=app.context;var clones=[];var indexes=[];var resources=[];var _iteratorNormalCompletion8=true;var _didIteratorError8=false;var _iteratorError8=undefined;try{for(var _iterator8=blocks[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=true){var block=_step8.value;var clone,index,resource;if(block.system){clone=block.cloneAsUserBlock()}else{clone=block.clone()}resource=newResource||app.context.assets.css.findResourceForBlock(block);if(!resource){continue}index=resource.findIndexForCSSBlock(block)>-1?resource.findIndexForCSSBlock(block)+1:resource.blocks.length;clones.push(clone);indexes.push(index);resources.push(resource);resource.addCSSBlockAtIndex(clone,index)}}catch(err){_didIteratorError8=true;_iteratorError8=err}finally{try{if(!_iteratorNormalCompletion8&&_iterator8["return"]){_iterator8["return"]()}}finally{if(_didIteratorError8){throw _iteratorError8}}}app.trigger("context-css-changed",context,resources);var that=this;app.context.history.add({name:title,undo:function undo(){for(var i=clones.length-1;i>=0;i--){that.getSelection().unselectItem(clones[i]);resources[i].deleteCSSBlocksAtIndex(indexes[i])}app.trigger("context-css-changed",context,resources)},redo:function redo(){for(var i=0;i<clones.length;i++){resources[i].addCSSBlockAtIndex(clones[i],indexes[i])}app.trigger("context-css-changed",context,resources)}})}},{key:"genericMoveBlockToCSSResource",value:function genericMoveBlockToCSSResource(newResource,blocks){var _iteratorNormalCompletion9=true;var _didIteratorError9=false;var _iteratorError9=undefined;try{for(var _iterator9=blocks[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=true){var block=_step9.value;if(!block.canBeSelected()){return}}}catch(err){_didIteratorError9=true;_iteratorError9=err}finally{try{if(!_iteratorNormalCompletion9&&_iterator9["return"]){_iterator9["return"]()}}finally{if(_didIteratorError9){throw _iteratorError9}}}var context=app.context;var clones=[];var oldResources=[];var oldIndexes=[];var _iteratorNormalCompletion10=true;var _didIteratorError10=false;var _iteratorError10=undefined;try{for(var _iterator10=blocks[Symbol.iterator](),_step10;!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=true){var block=_step10.value;var clone=block.clone();var oldResource=app.context.assets.css.findResourceForBlock(block);var oldIndex=oldResource.blocks.indexOf(block);clones.push(clone);oldIndexes.push(oldIndex);oldResources.push(oldResource);oldResource.deleteCSSBlocksAtIndex(oldIndex);this.getSelection().selectItem(clone);this.getSelection().unselectItem(block)}}catch(err){_didIteratorError10=true;_iteratorError10=err}finally{try{if(!_iteratorNormalCompletion10&&_iterator10["return"]){_iterator10["return"]()}}finally{if(_didIteratorError10){throw _iteratorError10}}}var newIndex=newResource.blocks.length;newResource.addCSSBlocksAtIndex(clones,newIndex);app.trigger("context-css-changed",context,[].concat(oldResources,[newResource]));var that=this;app.context.history.add({name:"Move CSS Block"+(blocks.length!==1?"s":""),undo:function undo(){newResource.deleteCSSBlocksAtIndex(newIndex,clones.length);for(var i=blocks.length-1;i>=0;i--){oldResources[i].addCSSBlockAtIndex(blocks[i],oldIndexes[i]);that.getSelection().unselectItem(clones[i])}app.trigger("context-css-changed",context,[].concat(oldResources,[newResource]))},redo:function redo(){for(var i=0;i<blocks.length;i++){oldResources[i].deleteCSSBlocksAtIndex(oldIndexes[i]);that.getSelection().unselectItem(blocks[i])}newResource.addCSSBlocksAtIndex(clones,newIndex);app.trigger("context-css-changed",context,[].concat(oldResources,[newResource]))}})}},{key:"getSelection",value:function getSelection(){if(!this.multipleSelection){var selectableCSSBlocks=this.cssBlocks.filter(function(block){return block.canBeSelected()});this.multipleSelection=multipleTreeSelection(selectableCSSBlocks,{rootCanBeSelected:false,type:"css"})}return this.multipleSelection}},{key:"toggleMediaQueryMenuAction",value:function toggleMediaQueryMenuAction(block){var query=false,oldQuery=block.mediaQuery;var context=app.context,resource=app.context.assets.css.findResourceForBlock(block);if(block.mediaQuery){query=false}else{query=app.framework.getMediaQueryForSize(app.context.canvasDimensions.width)}block.mediaQuery=query;this.refreshBlock(block);this.ignoreUpdatedEvent=true;app.trigger("context-css-changed",context,[resource]);this.ignoreUpdatedEvent=false;app.context.history.add({name:"Toggle CSS Media Query",undo:function undo(){block.mediaQuery=oldQuery;app.trigger("context-css-changed",context,[resource])},redo:function redo(){block.mediaQuery=query;app.trigger("context-css-changed",context,[resource])}})}},{key:"deleteBlockMenuAction",value:function deleteBlockMenuAction(blocks){this.deleteBlock(blocks);this.update()}},{key:"toggleBlockMenuAction",value:function toggleBlockMenuAction(blocks){var enable=arguments.length<=1||arguments[1]===undefined?null:arguments[1];var context=app.context;var cssFiles=[];var ops=[];var _iteratorNormalCompletion11=true;var _didIteratorError11=false;var _iteratorError11=undefined;try{for(var _iterator11=blocks[Symbol.iterator](),_step11;!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=true){var block=_step11.value;var css=context.assets.css.findResourceForBlock(block);ops.push(block.toggleOp(enable));cssFiles.push(css)}}catch(err){_didIteratorError11=true;_iteratorError11=err}finally{try{if(!_iteratorNormalCompletion11&&_iterator11["return"]){_iterator11["return"]()}}finally{if(_didIteratorError11){throw _iteratorError11}}}ops.forEach(function(op){return op["do"]()});app.trigger("context-css-changed",context,cssFiles);app.context.history.add({name:"Toggle CSS Blocks",undo:function undo(){ops.forEach(function(op){return op.undo()});app.trigger("context-css-changed",context,cssFiles)},redo:function redo(){ops.forEach(function(op){return op["do"]()});app.trigger("context-css-changed",context,cssFiles)}})}},{key:"showContextMenu",value:function showContextMenu(e){var menu=$(e.target).closest(".menu");var block=this.domToCSSItem.get(menu.closest(".css-block")[0]);var top=menu.offset().top;var left=menu.offset().left+menu.width();var copyTargets=this.getTargetsForAction(block,this.copyBlockMenuAction);var moveTargets=this.getTargetsForAction(block,this.moveBlockMenuAction);var options=[{name:"Copy to",options:copyTargets}];if(!block.isLocked()){options.push({name:"Move to",options:moveTargets});options.push({name:"Duplicate",action:this.duplicateBlockMenuAction.bind(this,block)});if(!(block instanceof CSSKeyframes)){var mq="Add Media Query";if(block.mediaQuery!==false){mq="Remove Media Query"}options.push({name:mq,action:this.toggleMediaQueryMenuAction.bind(this,block)})}options.push({name:function name(){return block.isEnabled()?"Enabled":"Disabled"},action:function action(e,value){var context=app.context;var resource=context.assets.css.findResourceForBlock(block);block.toggle();app.trigger("context-css-changed",context,[resource],block);context.history.add({name:"Toggle CSS Block",undo:function undo(){block.toggle();app.trigger("context-css-changed",context,[resource],block)},redo:function redo(){block.toggle();app.trigger("context-css-changed",context,[resource],block)}});return true},checkbox:true,checkboxChecked:block.isEnabled()});options.push({name:"Delete",action:this.deleteBlockMenuAction.bind(this,block)})}app.contextMenu.show(left,top,options,{gravity:"left"})}},{key:"getTargetsForAction",value:function getTargetsForAction(blocks,_action){if(!Array.isArray(blocks)){blocks=[blocks]}var targets=[];var resourcesForBlocks=[];var _iteratorNormalCompletion12=true;var _didIteratorError12=false;var _iteratorError12=undefined;try{for(var _iterator12=blocks[Symbol.iterator](),_step12;!(_iteratorNormalCompletion12=(_step12=_iterator12.next()).done);_iteratorNormalCompletion12=true){var block=_step12.value;if(!block.system){resourcesForBlocks.push(app.context.findResourceForCSSBlock(block))}}}catch(err){_didIteratorError12=true;_iteratorError12=err}finally{try{if(!_iteratorNormalCompletion12&&_iterator12["return"]){_iterator12["return"]()}}finally{if(_didIteratorError12){throw _iteratorError12}}}var _iteratorNormalCompletion13=true;var _didIteratorError13=false;var _iteratorError13=undefined;try{for(var _iterator13=app.context.assets.css.getLocalCSSResources()[Symbol.iterator](),_step13;!(_iteratorNormalCompletion13=(_step13=_iterator13.next()).done);_iteratorNormalCompletion13=true){var css=_step13.value;if(resourcesForBlocks.indexOf(css)!==-1){continue}targets.push({name:"/"+app.context.assets.css.getRelativePathForItem(css),action:_action.bind(this,css,blocks)})}}catch(err){_didIteratorError13=true;_iteratorError13=err}finally{try{if(!_iteratorNormalCompletion13&&_iterator13["return"]){_iterator13["return"]()}}finally{if(_didIteratorError13){throw _iteratorError13}}}var that=this;targets.push({name:"New Stylesheet",action:function action(){var style=app.getPanel("design").createNewCSSFile();_action.call(that,style,blocks)}});return targets}},{key:"shouldEnableSelection",value:function shouldEnableSelection(){var selection=this.getSelection();if(!selection)return false;var selectedItems=selection.getSelectedItems();var _iteratorNormalCompletion14=true;var _didIteratorError14=false;var _iteratorError14=undefined;try{for(var _iterator14=selectedItems[Symbol.iterator](),_step14;!(_iteratorNormalCompletion14=(_step14=_iterator14.next()).done);_iteratorNormalCompletion14=true){var item=_step14.value;if(item.isEnabled()){return false}}}catch(err){_didIteratorError14=true;_iteratorError14=err}finally{try{if(!_iteratorNormalCompletion14&&_iterator14["return"]){_iterator14["return"]()}}finally{if(_didIteratorError14){throw _iteratorError14}}}return true}},{key:"updateSearch",value:function updateSearch(){var scroll=arguments.length<=0||arguments[0]===undefined?false:arguments[0];this.numberResults.hide();if(!this.searchRegex){return}var searchResults=this.element[0].querySelectorAll(".search-match");if(this.resultIndex>searchResults.length-1){this.resultIndex=Math.max(searchResults.length-1,0)}if(!searchResults.length){this.numberResults.show().text("0 of 0")}else{this.numberResults.show().text(this.resultIndex+1+" of "+searchResults.length)}this.element.find(".search-match.highlighted").removeClass("highlighted");var node=this.element[0].querySelectorAll(".search-match")[this.resultIndex];if(node){node.classList.add("highlighted");this.resultHighlightID=node.highlightID;if(scroll){node.scrollIntoViewIfNeeded()}}}},{key:"updateMultipleSelectionButtons",value:function updateMultipleSelectionButtons(){var mainButtonsWrapper=this.element.find(".toolbar .main"),multipleSelectionButtons=this.element.find(".toolbar .multiple-selection");var hasMultipleSelection=this.hasMultipleSelection();mainButtonsWrapper.toggle(!hasMultipleSelection);multipleSelectionButtons.toggle(hasMultipleSelection);if(hasMultipleSelection){var enable=this.shouldEnableSelection();var toggleButton=multipleSelectionButtons.find(".toggle");toggleButton.attr("title",enable?"Enable":"Disable");toggleButton.text(enable?"Enable":"Disable");toggleButton.data("enable",enable)}}},{key:"update",value:function update(args){var content=this.element.find(".content"),message=this.element.find(".message"),buttons=this.element.find(".toolbar .main .button");var hasMultipleSelection=this.hasMultipleSelection();this.element.toggleClass("multiple-selection-active",hasMultipleSelection);if(app.context.page.hasFocusedNode()){content.show();buttons.removeClass("disabled");message.hide()}else{content.hide().empty();buttons.addClass("disabled");message.show();this.clearSelection();this.updateMultipleSelectionButtons();return}var allBlocks=new Set,result,pseudoBlocks=[],cssItem;var component=app.context.page.getFocusedComponent();var element=app.context.page.getFocusedNode();var path=component.getPathForChildElement(element);this.cssGroups=[];this.cssBlocks=[];if(!element){return this.element}if(!app.canvas.contains(app.context.page.getFocusedNode())){return this.element}var addonBlocks=[];addonBlocks.push.apply(addonBlocks,_toConsumableArray(this.getModifiedBlocks(app.context.page.getFocusedNode())));if(this.hasFocus()&&this.focus.type=="new-selector"){addonBlocks.unshift(this.focus.block)}var keyframeNames=new Set;while(element.nodeType!=Node.DOCUMENT_NODE){cssItem={blocks:[],inherited:app.context.page.getFocusedNode()!=element,inheritedFrom:prettyDOMNodeName(element)};var matching=app.context.getMatchingCSSBlocks(element);for(var i=0;i<matching.length;i++){var block=matching[i].block;var result=matching[i].result;if(allBlocks.has(block)||addonBlocks.indexOf(block)>-1)continue;if(cssItem.inherited&&!block.isInheritable()){continue}block.cleanEmptyRules();allBlocks.add(block);block.getLinkedKeyframeNames().forEach(function(name){return keyframeNames.add(name)});this.blockMatchedSelectors.set(block,result.selectors);if(result.isPseudo){pseudoBlocks.push(block)}else{cssItem.blocks.push(block)}}if(element==app.context.page.getFocusedNode()&&path&&component.canPathHaveStyle(path)){cssItem.blocks.unshift(component.getPathStyleAsCSSBlock(path))}if(cssItem.blocks.length||element==app.context.page.getFocusedNode()){this.cssGroups.push(cssItem)}if(cssItem.blocks.length){var _cssBlocks;(_cssBlocks=this.cssBlocks).push.apply(_cssBlocks,_toConsumableArray(cssItem.blocks))}element=element.parentNode}if(addonBlocks.length){var _cssBlocks2;var index=component.canPathHaveStyle(path)?1:0;if(this.cssGroups.length){var _cssGroups$0$blocks;(_cssGroups$0$blocks=this.cssGroups[0].blocks).splice.apply(_cssGroups$0$blocks,[index,0].concat(addonBlocks))}(_cssBlocks2=this.cssBlocks).splice.apply(_cssBlocks2,[index,0].concat(addonBlocks))}if(keyframeNames.size){var _cssBlocks3;var keyframes=[];var _iteratorNormalCompletion15=true;var _didIteratorError15=false;var _iteratorError15=undefined;try{for(var _iterator15=keyframeNames[Symbol.iterator](),_step15;!(_iteratorNormalCompletion15=(_step15=_iterator15.next()).done);_iteratorNormalCompletion15=true){var _name=_step15.value;var _iteratorNormalCompletion16=true;var _didIteratorError16=false;var _iteratorError16=undefined;try{for(var _iterator16=app.context.getAllCSSCached()[Symbol.iterator](),_step16;!(_iteratorNormalCompletion16=(_step16=_iterator16.next()).done);_iteratorNormalCompletion16=true){var comb=_step16.value;if(comb instanceof CSSKeyframes&&comb.name==_name&&addonBlocks.indexOf(comb)==-1){keyframes.push(comb)}}}catch(err){_didIteratorError16=true;_iteratorError16=err}finally{try{if(!_iteratorNormalCompletion16&&_iterator16["return"]){_iterator16["return"]()}}finally{if(_didIteratorError16){throw _iteratorError16}}}}}catch(err){_didIteratorError15=true;_iteratorError15=err}finally{try{if(!_iteratorNormalCompletion15&&_iterator15["return"]){_iterator15["return"]()}}finally{if(_didIteratorError15){throw _iteratorError15}}}if(keyframes.length){this.cssGroups.push({blocks:keyframes,keyframes:true})}(_cssBlocks3=this.cssBlocks).push.apply(_cssBlocks3,keyframes)}if(pseudoBlocks.length){var _cssBlocks4;this.cssGroups.push({blocks:pseudoBlocks,pseudo:true});(_cssBlocks4=this.cssBlocks).push.apply(_cssBlocks4,pseudoBlocks)}this.updateMultipleSelectionButtons();var groups=this.cssGroups.map(this.renderGroup.bind(this));var fragment=document.createDocumentFragment();for(var i=0;i<groups.length;i++){fragment.appendChild(groups[i])}content.empty();content.append(fragment);this.updateSearch(args&&args.scrollToSearchResult);this.focusContentEditable(content[0]);return this.element}}]);return ActiveStyles}(Editor);module.exports=ActiveStyles},{"../base/CSSBlock":12,"../base/CSSBlockStyle":13,"../base/CSSKeyframes":14,"../base/CSSRule":15,"../config/css-properties":367,"../helpers/compareSelectorSpecificity":550,"../helpers/dragScroll":558,"../helpers/escapeRegexString":561,"../helpers/formatCSSSelector":566,"../helpers/hasSelection":577,"../helpers/highlightMatches":578,"../helpers/insertAtCaret":583,"../helpers/isSelectionClick":585,"../helpers/keyChecker":586,"../helpers/multipleTreeSelection":589,"../helpers/parseCSS":593,"../helpers/prettyDOMNodeName":598,"../helpers/quickParseCSSRules":599,"../helpers/saveRestoreCaretPosition":607,"../helpers/selectElementContents":609,"../panels/SuggestionTooltip":1241,"./Editor":532,"escape-html":1021}]
});