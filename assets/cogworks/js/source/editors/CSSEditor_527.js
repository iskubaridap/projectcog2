define([],function(){
	return [function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x3,_x4,_x5){var _again=true;_function:while(_again){var object=_x3,property=_x4,receiver=_x5;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x3=parent;_x4=property;_x5=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,
configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var ActiveStyles=require("./ActiveStyles");var dragScroll=require("../helpers/dragScroll");var CSSBlock=require("../base/CSSBlock");var prettyDOMNodeName=require("../helpers/prettyDOMNodeName");var hasSelection=require("../helpers/hasSelection");var CSSEditor=function(_ActiveStyles){_inherits(CSSEditor,_ActiveStyles);function CSSEditor(resource){_classCallCheck(this,CSSEditor);_get(Object.getPrototypeOf(CSSEditor.prototype),"constructor",this).call(this);this.target=resource;this.system=false;this.element.removeClass("active-styles");this.element.find(".message").remove();this.mode="css-editor";this.blockSizes=[];this.lastSpacerIsHighlighted=false;this.isDragging=false;this.isMousedown=false;this.isMouseAbove=false;this.mouseDownStartCoordinates=null;this.overIndex=-1;this.draggedBlockIndex=null;this.styleDragGhost=$("#style-drag");this.ignoreContentClicks=false;this.content=this.element.find(".content");this.contentNode=this.content[0];this.mouseupListener=this.mouseup.bind(this);this.mousemoveListener=this.mousemove.bind(this)}_createClass(CSSEditor,[{key:"bindEventListeners",value:function bindEventListeners(){_get(Object.getPrototypeOf(CSSEditor.prototype),"bindEventListeners",this).call(this);var dom=this.element;dom.on("click","div.spacer",this.clickSpacer.bind(this));dom.on("mouseenter","div.spacer:not(:last-child)",this.enterSpacer.bind(this));dom.on("mouseleave","div.spacer:not(:last-child)",this.leaveSpacer.bind(this));dom.on("click",".content",this.clickContent.bind(this));dom.on("mousedown",".css-block .handle",this.mousedownHandle.bind(this));dom.on("mouseenter",".content",this.mouseenter.bind(this));dom.on("mouseleave",".content",this.mouseleave.bind(this));app.on("mouseup",this.mouseupListener);app.on("mousemove",this.mousemoveListener)}},{key:"unbindEventListeners",value:function unbindEventListeners(){_get(Object.getPrototypeOf(CSSEditor.prototype),"unbindEventListeners",this).call(this);app.off("mouseup",this.mouseupListener);app.off("mousemove",this.mousemoveListener)}},{key:"contextCSSChanged",value:function contextCSSChanged(context,resources,block){if(resources.indexOf(this.getTargetCSSResource())>-1){_get(Object.getPrototypeOf(CSSEditor.prototype),"contextCSSChanged",this).call(this)}}},{key:"contextSASSChanged",value:function contextSASSChanged(){}},{key:"componentSelected",value:function componentSelected(components){this.handlePendingChanges();this.stopAnimations();this.resetFocus()}},{key:"componentUnselected",value:function componentUnselected(components){this.handlePendingChanges();this.stopAnimations();this.resetFocus()}},{key:"componentFocused",value:function componentFocused(component){this.handlePendingChanges();this.stopAnimations();this.resetFocus()}},{key:"componentBlurred",value:function componentBlurred(component){this.handlePendingChanges();this.stopAnimations();this.resetFocus()}},{key:"componentUpdated",value:function componentUpdated(component){if(this.ignoreUpdatedEvent)return;if(app.isInlineEditingActive())return;this.handlePendingChanges();this.resetFocus()}},{key:"getName",value:function getName(){return this.target.name}},{key:"targetExists",value:function targetExists(){return app.context.hasResource(this.target)}},{key:"mouseenter",value:function mouseenter(){this.isMouseAbove=true}},{key:"mouseleave",value:function mouseleave(){this.isMouseAbove=false}},{key:"clickContent",value:function clickContent(e){if(this.ignoreContentClicks)return;if(e.target!=this.content[0])return;var highlightedSpacer=this.content.find("div.spacer.highlight");if(highlightedSpacer.length){highlightedSpacer.click()}else if(!hasSelection()&&this.lastSpacerIsHighlighted){this.createNewEmptyBlockAndFocus(this.cssBlocks.length)}}},{key:"mousedownHandle",value:function mousedownHandle(e){var blockNode=e.target.closest(".css-block");var block=this.domToCSSItem.get(blockNode);if(!block)return;this.draggedBlockIndex=this.cssBlocks.indexOf(block);this.isMousedown=true;this.mouseDownStartCoordinates=app.mousePosition.clone();if(this.focus){var focusBlock=this.focus.block;this.resetFocus();this.refreshBlock(focusBlock)}e.preventDefault();e.stopImmediatePropagation()}},{key:"startDrag",value:function startDrag(){var block=this.cssBlocks[this.draggedBlockIndex];this.styleDragGhost.text(block.selector).show();this.isDragging=true;this.cssItemToDOM.get(block).classList.add("is-dragged");this.ignoreContentClicks=true;this.scanCSSBlockSizes();this.dragMove()}},{key:"stopDrag",value:function stopDrag(){dragScroll.reset(this.contentNode);this.styleDragGhost.hide();this.draggedBlockIndex=null;this.isDragging=false;this.isMousedown=false;this.mouseDownStartCoordinates=null;this.overIndex=-1;this.content.find("div.spacer.highlight").removeClass("highlight");this.element.find(".is-dragged").removeClass("is-dragged");var that=this;setTimeout(function(){that.ignoreContentClicks=false},100)}},{key:"dragMove",value:function dragMove(){var rect=this.contentNode.getBoundingClientRect();var y=app.mousePosition.y;var distanceFromTop=y-rect.top;var distanceFromCSSList=distanceFromTop+this.contentNode.scrollTop;var index=this.getBlockIndexByY(distanceFromCSSList);if(index>-1&&(index==this.draggedBlockIndex||index-1==this.draggedBlockIndex)){index=-1}if(this.overIndex!=index){if(index>=0){this.content.find("div.spacer").eq(index).addClass("highlight")}else{this.content.find("div.spacer.highlight").removeClass("highlight")}this.overIndex=index}this.styleDragGhost[0].style.transform="translate3D("+app.mousePosition.x+"px,"+app.mousePosition.y+"px, 0)";dragScroll.scroll(this.contentNode,rect,rect,app.mousePosition,{topOffset:50,bottomOffset:50,speedUpScrolling:true})}},{key:"dragEnd",value:function dragEnd(){if(!this.isDragging)return;if(this.overIndex>-1){var block=this.cssBlocks[this.draggedBlockIndex];this.moveBlock(block,this.overIndex)}this.stopDrag()}},{key:"getBlockIndexByY",value:function getBlockIndexByY(y){var sum=0;for(var i=0;i<this.blockSizes.length;i++){if(y<sum+30){return i}sum+=this.blockSizes[i].height+10;if(y<sum-20){return-1}}return this.blockSizes.length}},{key:"betweenBlocks",value:function betweenBlocks(y){var sum=0;for(var i=0;i<this.blockSizes.length;i++){if(y<sum+10){return i}sum+=this.blockSizes[i].height+10;if(y<sum){return-1}}return this.blockSizes.length}},{key:"getLinePosition",value:function getLinePosition(index){var sum=0;for(var i=0;i<index;i++){sum+=this.blockSizes[i].height+10}return sum+5}},{key:"mousemove",value:function mousemove(e){if(!this.isMouseAbove){if(this.lastSpacerIsHighlighted){this.unhighlightLastSpacer()}if(this.isDragging){this.stopDrag()}return}if(this.isDragging){this.dragMove();return}if(this.isMousedown){if(this.mouseDownStartCoordinates&&this.mouseDownStartCoordinates.distanceTo(app.mousePosition)>3){this.startDrag()}return}if(!this.hasFocus()&&this.isMouseAfterLastBlock()){this.highlightLastSpacer()}else{this.unhighlightLastSpacer()}}},{key:"isMouseAfterLastBlock",value:function isMouseAfterLastBlock(){if(!this.cssBlocks.length){return true}var block=this.cssBlocks[this.cssBlocks.length-1];if(!block)return;var blockDOM=this.cssItemToDOM.get(block);if(!blockDOM)return;var rect=blockDOM.getBoundingClientRect();return app.mousePosition.y>rect.bottom}},{key:"highlightLastSpacer",value:function highlightLastSpacer(){if(this.lastSpacerIsHighlighted)return;var last=this.element[0].querySelector("div.spacer:last-child");if(last){last.classList.add("highlight")}this.lastSpacerIsHighlighted=true}},{key:"unhighlightLastSpacer",value:function unhighlightLastSpacer(e){if(!this.lastSpacerIsHighlighted)return;var last=this.element[0].querySelector("div.spacer:last-child");if(last){last.classList.remove("highlight")}this.lastSpacerIsHighlighted=false}},{key:"enterSpacer",value:function enterSpacer(e){if(app.isDragging)return;if(this.focus||this.isDragging)return;if(this.hasMultipleSelection())return;e.target.classList.add("highlight")}},{key:"leaveSpacer",value:function leaveSpacer(e){if(app.isDragging)return;if(this.isDragging)return;e.target.classList.remove("highlight")}},{key:"clickSpacer",value:function clickSpacer(e){if(this.focus)return;if(this.hasMultipleSelection())return;var allSpacers=this.element.find("div.spacer");var index=allSpacers.index(e.target);this.createNewEmptyBlockAndFocus(index)}},{key:"mouseup",value:function mouseup(e){this.isMousedown=false;this.dragEnd()}},{key:"getTargetCSSResource",value:function getTargetCSSResource(){return this.target}},{key:"scanCSSBlockSizes",value:function scanCSSBlockSizes(){var blockNodes=this.element.find(".css-block").toArray();this.blockSizes=blockNodes.map(function(node){var rect=node.getBoundingClientRect();return{height:rect.height,block:this.domToCSSItem.get(node)}}.bind(this))}},{key:"createNewEmptyBlockAndFocus",value:function createNewEmptyBlockAndFocus(){var index=arguments.length<=0||arguments[0]===undefined?0:arguments[0];var defaultSelector="";if(app.context.page.hasFocusedNode()){defaultSelector=prettyDOMNodeName(app.context.page.getFocusedNode())}var block=new CSSBlock(defaultSelector);this.focusNewBlockSelector(block,index);this.update()}},{key:"moveBlock",value:function moveBlock(block,newIndex){var css=app.context.assets.css.findResourceForBlock(block);var context=app.context;if(!css)return;var oldIndex=css.findIndexForCSSBlock(block);if(newIndex>oldIndex){newIndex--}css.blocks.splice(oldIndex,1);css.blocks.splice(newIndex,0,block);app.trigger("context-css-changed",context,[css]);app.context.history.add({name:"Delete CSS Block",undo:function undo(){css.blocks.splice(newIndex,1);css.blocks.splice(oldIndex,0,block);app.trigger("context-css-changed",context,[css])},redo:function redo(){css.blocks.splice(oldIndex,1);css.blocks.splice(newIndex,0,block);app.trigger("context-css-changed",context,[css])}})}},{key:"update",value:function update(){var args=arguments.length<=0||arguments[0]===undefined?null:arguments[0];var content=this.content;var cssBlocks=this.target.blocks;this.lastSpacerIsHighlighted=false;this.searchButton.toggleClass("disabled",!cssBlocks.length);this.cssBlocks=cssBlocks;if(this.focus&&this.focus.type=="new-selector"){cssBlocks=cssBlocks.slice();cssBlocks.splice(this.focus.index,0,this.focus.block)}var hasMultipleSelection=this.hasMultipleSelection();this.element.toggleClass("multiple-selection-active",hasMultipleSelection);this.updateMultipleSelectionButtons();if(!cssBlocks.length){content.empty();return}var blocks=cssBlocks.map(this.renderBlock.bind(this));var fragment=document.createDocumentFragment();var spacer;for(var i=0;i<blocks.length;i++){spacer=document.createElement("div");spacer.setAttribute("class","spacer");fragment.appendChild(spacer);fragment.appendChild(blocks[i])}spacer=document.createElement("div");spacer.setAttribute("class","spacer");fragment.appendChild(spacer);content.html(fragment);this.updateSearch(args&&args.scrollToSearchResult);this.focusContentEditable(content[0]);return this.element}}]);return CSSEditor}(ActiveStyles);module.exports=CSSEditor},{"../base/CSSBlock":12,"../helpers/dragScroll":558,"../helpers/hasSelection":577,"../helpers/prettyDOMNodeName":598,"./ActiveStyles":526}]
});