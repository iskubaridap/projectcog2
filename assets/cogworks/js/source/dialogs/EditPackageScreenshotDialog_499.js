define([],function(){
	return [function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Dialog=require("./Dialog");var getImageCrop=require("../helpers/getImageCrop");var EditPackageScreenshotDialog=function(_Dialog){_inherits(EditPackageScreenshotDialog,_Dialog);function EditPackageScreenshotDialog(elem){_classCallCheck(this,EditPackageScreenshotDialog);_get(Object.getPrototypeOf(EditPackageScreenshotDialog.prototype),"constructor",this).call(this,elem);this.okButton=elem.find(".button.ok");this.okButton.on("click",this.onSave.bind(this));elem.find(".button.cancel").on("click",this.close.bind(this));elem.find(".zoom-in").on("click",this.zoomIn.bind(this));elem.find(".zoom-out").on("click",this.zoomOut.bind(this));this.state="loading";this.cropArea=elem.find(".crop-area");this.cropArea.on("mousedown",this.cropAreaMousedown.bind(this));this.cropArea.on("mouseup",this.cropAreaMouseup.bind(this))
;this.cropArea.on("mouseleave",this.cropAreaMouseleave.bind(this));this.cropArea.on("mousemove",this.cropAreaMousemove.bind(this));this.originalPreview=null;this.hasPreivew=false;this.img=null;this.offset={left:0,top:0};this.tmpOffset={left:0,top:0};this.startMousePos=null;this.distance={x:0,y:0};this.imageSize={width:0,height:0};this.areaSize={width:496,height:285};this.scale=null;this.minScale=.1;this.maxScale=1;this.scaleStep=.25;this.mouseIsDown=false}_createClass(EditPackageScreenshotDialog,[{key:"cropAreaMousemove",value:function cropAreaMousemove(e){if(!this.mouseIsDown||this.state!="ready")return;this.distance=app.mousePosition.distanceToXY(this.startMousePos);this.positionImage()}},{key:"cropAreaMousedown",value:function cropAreaMousedown(e){this.mouseIsDown=true;this.startMousePos=app.mousePosition.clone()}},{key:"cropAreaMouseup",value:function cropAreaMouseup(){this.mouseIsDown=false;this.recordImagePosition()}},{key:"cropAreaMouseleave",value:function cropAreaMouseleave(){this.mouseIsDown=false;this.recordImagePosition()}},{key:"zoomIn",value:function zoomIn(){if(this.scale>=this.maxScale)return;var oldScale=this.scale;this.scale+=this.scaleStep;if(this.scale>=this.maxScale){this.scale=this.maxScale}var ratio=this.scale/oldScale;this.offset.left*=ratio;this.offset.top*=ratio;this.positionImage();this.recordImagePosition()}},{key:"zoomOut",value:function zoomOut(){if(this.scale<=this.minScale)return;var oldScale=this.scale;this.scale-=this.scaleStep;if(this.scale<=this.minScale){this.scale=this.minScale}var ratio=this.scale/oldScale;this.offset.left*=ratio;this.offset.top*=ratio;this.positionImage();this.recordImagePosition()}},{key:"open",value:function open(options){_get(Object.getPrototypeOf(EditPackageScreenshotDialog.prototype),"open",this).call(this,options);var pkg=options["package"];this.originalPreview=null;this.hasPreview=false;this.scale=pkg.previewScale;this.offset={top:0,left:0};if(pkg.previewOffset){this.offset.left=pkg.previewOffset.left;this.offset.top=pkg.previewOffset.top}var that=this;that.state="loading";pkg.generatePreview(function(largeImage){if(largeImage){that.originalPreview=largeImage;that.hasPreview=true}that.state="ready";that.update()},{width:992,height:992})}},{key:"afterClose",value:function afterClose(){this.element.find(".crop-area img").remove();this.img=null;this.originalPreview=null;this.hasPreview=false;this.state="loading"}},{key:"onSave",value:function onSave(){if(this.state!="ready"||!this.hasPreview){return}var newSize={width:0,height:0};newSize.width=Math.min(this.imageSize.width*this.scale,this.areaSize.width);newSize.height=Math.min(this.imageSize.height*this.scale,this.areaSize.height);var offset={top:0,left:0};if(this.offset.left<0){offset.left=-this.offset.left/this.scale}if(this.offset.top<0){offset.top=-this.offset.top/this.scale}var originalSize={width:newSize.width/this.scale,height:newSize.height/this.scale};var data=getImageCrop(this.img,originalSize,offset,newSize);this.options.onSave({preview:data,offset:this.offset,scale:this.scale});this.close()}},{key:"recordImagePosition",value:function recordImagePosition(){this.offset.left=this.tmpOffset.left;this.offset.top=this.tmpOffset.top;this.distance.x=0;this.distance.y=0}},{key:"positionImage",value:function positionImage(){if(!this.hasPreview)return;var img=this.img;var scale=this.scale;var offset=this.offset;var distance=this.distance;var tmpOffset=this.tmpOffset;var areaSize=this.areaSize;tmpOffset.left=0;tmpOffset.top=0;var currentWidth=this.imageSize.width*scale,currentHeight=this.imageSize.height*scale;if(areaSize.width>currentWidth){tmpOffset.left=(areaSize.width-currentWidth)/2}else{tmpOffset.left=offset.left+this.distance.x;if(tmpOffset.left>0){tmpOffset.left=0}if(areaSize.width>tmpOffset.left+currentWidth){tmpOffset.left=areaSize.width-currentWidth}}if(areaSize.height>currentHeight){tmpOffset.top=(areaSize.height-currentHeight)/2}else{tmpOffset.top=offset.top+this.distance.y;if(tmpOffset.top>0){tmpOffset.top=0}if(areaSize.height>tmpOffset.top+currentHeight){tmpOffset.top=areaSize.height-currentHeight}}img.style.transform="scale("+scale+")";img.style.left=tmpOffset.left+"px";img.style.top=tmpOffset.top+"px"}},{key:"update",value:function update(){this.cropArea.empty();this.okButton.addClass("disable");if(this.state=="loading"){this.cropArea.append('<div class="status">Loading..</div>');return}this.element.removeClass("no-preview-available can-scale");var that=this;if(this.state=="ready"){if(this.hasPreview){this.img=new Image;this.img.onload=function(){that.imageSize.width=that.img.naturalWidth;that.imageSize.height=that.img.naturalHeight;if(that.imageSize.width<that.areaSize.width&&that.imageSize.height<that.areaSize.height){that.minScale=1;that.scaleStep=0;that.scale=1}else{if(that.imageSize.width/that.imageSize.height>that.areaSize.width/that.areaSize.height){that.minScale=that.areaSize.width/that.imageSize.width}else{that.minScale=that.areaSize.height/that.imageSize.height}var steps=3;if(that.minScale>.7){steps=2}that.scaleStep=(that.maxScale-that.minScale)/steps;if(!that.scale||that.scale<that.minScale){that.scale=that.minScale}that.element.addClass("can-scale");that.okButton.removeClass("disable")}that.positionImage();that.img.style.display=""};this.img.src=this.originalPreview;this.img.style.display="none";this.cropArea.append(this.img)}else{this.element.addClass("no-preview-available");this.cropArea.append('<div class="status">No preview available.</div>')}}}}]);return EditPackageScreenshotDialog}(Dialog);module.exports=EditPackageScreenshotDialog},{"../helpers/getImageCrop":574,"./Dialog":498}]
});