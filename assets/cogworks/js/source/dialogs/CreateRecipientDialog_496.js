define([],function(){
	return [function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x2,_x3,_x4){var _again=true;_function:while(_again){var object=_x2,property=_x3,receiver=_x4;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x2=parent;_x3=property;_x4=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Dialog=require("./Dialog");var CreateRecipientDialog=function(_Dialog){_inherits(CreateRecipientDialog,_Dialog);function CreateRecipientDialog(elem){_classCallCheck(this,CreateRecipientDialog);_get(Object.getPrototypeOf(CreateRecipientDialog.prototype),"constructor",this).call(this,elem);this.mode="create";this.message={status:"success",text:""};this.title=elem.find(".dialog-title");this.content=elem.find(".content");this.email=elem.find("input[name=email]");this.confirmationCode=elem.find("input[name=code]");this.email.on("keydown",this.inputKeydown.bind(this));this.confirmationCode.on("keydown",this.inputKeydown.bind(this));this.createMode=elem.find(".mode.create");this.verifyMode=elem.find(".mode.verify");this.sendVerivicationButton=elem.find(".send-verification");this.sendVerivicationButton.on("click",this.onSendVerificationButtonClick.bind(this));this.okButton=elem.find(".button.primary");this.okButton.on("click",this.onOK.bind(this));elem.find(".button.cancel").on("click",this.close.bind(this));this.validationTimeout=null}_createClass(CreateRecipientDialog,[{key:"inputKeydown",value:function inputKeydown(e){var _this=this;if(e.which==13)this.onOK();clearTimeout(this.validationTimeout);this.validationTimeout=setTimeout(function(){var target=e.target;if(target.validity.valid){_this.resetErrors();_this.update()}else{_this.errors=_defineProperty({},target.name,[target.validationMessage]);_this.update()}},500)}},{key:"open",value:function open(){var options=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];this.mode=options.mode||"create";this.recipient=options.recipient||null;if(this.mode==="verify"){this.sendVerification()}_get(Object.getPrototypeOf(CreateRecipientDialog.prototype),"open",this).call(this,options);this.update();this.email.focus()}},{key:"onOK",value:function onOK(){switch(this.mode){case"create":this.createRecipient();break;case"verify":this.verifyRecipient();break}}},{key:"onSendVerificationButtonClick",value:function onSendVerificationButtonClick(e){e.preventDefault();this.sendVerification()}},{key:"sendVerification",value:function sendVerification(){var _this2=this;if(this.working)return;this.working=true;app.plugin.sendRecipientVerification(this.recipient.id).then(function(response){app.notifications.create({type:"success",title:"Verification sent",description:"Please check "+_this2.recipient.email}).show();_this2.working=false;_this2.update()})["catch"](function(response){app.notifications.create({type:"error",title:"Verification couldn't be sent",description:"Please try again in a few moments."}).show();_this2.working=false;_this2.update()});this.update()}},{key:"createRecipient",value:function createRecipient(){var _this3=this;if(this.working||!this.email[0].validity.valid)return;this.working=true;app.plugin.createRecipient({email:this.email.val()}).then(function(recipient){_this3.working=false;_this3.recipient=recipient;if(_this3.recipient.verified){app.notifications.create({type:"success",title:recipient.email+" created",description:"You can select it in the Recipient dropdown."}).show();_this3.close()}else{_this3.mode="verify";_this3.update()}})["catch"](function(response){if(response.status===403){app.notifications.create({type:"error",title:"Couldn't create recipient",description:response.responseJSON.message}).show()}else{_this3.errors=response.responseJSON.errors}_this3.working=false;_this3.update()});this.resetMessage();this.resetErrors();this.update()}},{key:"verifyRecipient",value:function verifyRecipient(){var _this4=this;if(this.working)return;this.working=true;app.plugin.verifyRecipient(this.recipient.id,this.confirmationCode.val()).then(function(recipient){app.notifications.create({type:"success",title:recipient.email+" was verified",description:"You can select it in the Recipient dropdown."}).show();_this4.working=false;_this4.close()})["catch"](function(response){_this4.errors=response.responseJSON.errors;_this4.working=false;_this4.update()});this.resetMessage();this.resetErrors();this.update()}},{key:"setMessage",value:function setMessage(status,text){this.message.status=status;this.message.text=text}},{key:"resetMessage",value:function resetMessage(){this.message.status="";this.message.text=""}},{key:"resetErrors",value:function resetErrors(){this.errors={}}},{key:"updateErrors",value:function updateErrors(){this.element.find(".errors").remove();for(var invalidInput in this.errors){var errors=$('<div class="errors">');var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.errors[invalidInput][Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var errorText=_step.value;var error=$('<p class="error-bubble">');error.text(errorText);errors.append(error)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator["return"]){_iterator["return"]()}}finally{if(_didIteratorError){throw _iteratorError}}}this.element.find("[name="+invalidInput+"]").after(errors)}}},{key:"updateMessage",value:function updateMessage(){this.element.find(".message").remove();if(this.message.text){var message=$('<div class="message">');message.addClass(this.message.status);message.text(this.message.text);this.content.prepend(message)}}},{key:"afterClose",value:function afterClose(){this.resetMessage();this.resetErrors();this.email.val("");this.confirmationCode.val("")}},{key:"update",value:function update(){this.updateErrors();this.updateMessage();if(this.mode==="create"){this.title.text("Create New Recipient");this.okButton.text("Create");this.okButton.attr("disabled",!this.email[0].validity.valid);this.okButton.toggleClass("disable",!this.email[0].validity.valid)}else{this.title.text("Verify Recipient");this.okButton.text("Verify");this.okButton.attr("disabled",!this.confirmationCode[0].validity.valid);this.okButton.toggleClass("disable",!this.confirmationCode[0].validity.valid)}if(this.working){this.element.addClass("loading");return}this.element.removeClass("loading");this.createMode.toggle(this.mode==="create");this.verifyMode.toggle(this.mode==="verify");return _get(Object.getPrototypeOf(CreateRecipientDialog.prototype),"update",this).call(this)}}]);return CreateRecipientDialog}(Dialog);module.exports=CreateRecipientDialog},{"./Dialog":498}]
});