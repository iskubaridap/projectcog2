define([],function(){
	return [function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x4,_x5,_x6){var _again=true;_function:while(_again){var object=_x4,property=_x5,receiver=_x6;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x4=parent;_x5=property;_x6=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Canvas=require("../base/Canvas");var History=require("../base/History");var EditorGroup=require("../editors/EditorGroup");var HTMLTree=require("../editors/HTMLTree");var ActiveStyles=require("../editors/ActiveStyles");var Context=require("./Context");var quickParseCSSRules=require("../helpers/quickParseCSSRules");var stable=require("stable");var blobURLRegex=/blob:[^)'"\s]+/g;var DesignContext=function(_Context){_inherits(DesignContext,_Context);function DesignContext(name,path,theme){_classCallCheck(this,DesignContext);_get(Object.getPrototypeOf(DesignContext.prototype),"constructor",this).call(this,name,path,theme);this.isDesign=true;this.themeCSS=[];this.page=null;this.history=new History(100,this);this.historyStackID=this.history.stackID;this.backupHistoryID=this.history.stackID;this.blockToCSSCache=new WeakMap;this.leftEditorGroup=new EditorGroup;this.rightEditorGroup=new EditorGroup;this.htmlTreeEditor=new HTMLTree;this.activeStylesEditor=new ActiveStyles;this.leftEditorGroup.add(this.htmlTreeEditor);this.rightEditorGroup.add(this.activeStylesEditor);this.previousBreadcrumbList=null;this.canvasDimensions={zoom:1,width:null,height:600};this.uiState={assetCategories:{}};this.scrollPosition={iframe:{x:0,y:0},canvas:{x:0,y:0}};this._cssAllBlocksCache=null;this._cssMatchingCache=new WeakMap;this.styleTargetMap=new WeakMap;this.assetPath="../assets/cogworks/embed/";this.lastSaveTime=null;this.publishSession=null;this.lastPublishJSON=null;this.needsSCSSCompilation=false}_createClass(DesignContext,[{key:"destructor",value:function destructor(){this.assets.images.getAll().forEach(function(asset){return asset.destructor()});this.previousBreadcrumbList=null}},{key:"destructEditors",value:function destructEditors(){this.leftEditorGroup.destructEditors();this.rightEditorGroup.destructEditors()}},{key:"setCopyOrigin",value:function setCopyOrigin(component){var id=Math.floor(Math.random()*99999999);this.copyOrigin=_defineProperty({},id,component);return id}},{key:"getCopyOrigin",value:function getCopyOrigin(id){this.updateCopyOrigin();if(!this.copyOrigin||!this.copyOrigin.hasOwnProperty(id))return null;if(!this.copyOrigin[id].exists())return false;return this.copyOrigin[id]}},{key:"updateCopyOrigin",value:function updateCopyOrigin(){var toDelete=[];for(var id in this.copyOrigin){if(!this.copyOrigin[id].exists()){toDelete.push(id)}}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=toDelete[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var del=_step.value;delete this.copyOrigin[del]}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator["return"]){_iterator["return"]()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"hasPublishSession",value:function hasPublishSession(){return!!this.publishSession}},{key:"getPublishSession",value:function getPublishSession(){return this.publishSession}},{key:"setPublishSession",value:function setPublishSession(sess){return this.publishSession=sess}},{key:"resetPublishSession",value:function resetPublishSession(){return this.publishSession=null}},{key:"acquirePreviewContext",value:function acquirePreviewContext(){var PreviewContext=require("./PreviewContext");if(!this._previewContext){this._previewContext=new PreviewContext;this._previewContext.unserialize(this.serialize());this.smartTransfer(this._previewContext)}return this._previewContext}},{key:"invalidatePreviewContext",value:function invalidatePreviewContext(){delete this._previewContext}},{key:"smartTransfer",value:function smartTransfer(otherContext){this.transferCompiledSASSCode(otherContext)}},{key:"transferCompiledSASSCode",value:function transferCompiledSASSCode(otherContext){var path;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=app.context.assets.css.getLocalSASSResources()[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var sass=_step2.value;if(sass.isPartial()){continue}path=app.context.assets.css.getRelativePathForItem(sass);otherContext.assets.css.getItemByRelativePath(path).compiled=sass.compiled}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2["return"]){_iterator2["return"]()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}},{key:"extractColors",value:function extractColors(){var colors=[];var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=app.context.getUserCSS()[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var block=_step3.value;var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=block.rules[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var rule=_step4.value;if(!rule.isColorRelated())continue;var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=rule.extractColors()[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var col=_step5.value;if(colors.indexOf(col.color)==-1){colors.push(col.color)}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5["return"]){_iterator5["return"]()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4["return"]){_iterator4["return"]()}}finally{if(_didIteratorError4){throw _iteratorError4}}}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3["return"]){_iterator3["return"]()}}finally{if(_didIteratorError3){throw _iteratorError3}}}return colors}},{key:"transformImageResource",value:function transformImageResource(path,options){path=path.replace(/^\/(?:images|img)\//,"");var asset=this.assets.images.getItemByRelativePath(path);if(!asset)return false;return asset.blobURL}},{key:"replaceBlobURLWithImagePath",value:function replaceBlobURLWithImagePath(str){var that=this;return str.replace(blobURLRegex,function(match){var img=that.assets.images.findImageByBlobURL(match);if(img){return that.assets.images.getRelativePathForItem(img)}return match})}},{key:"getURLForJS",value:function getURLForJS(js){return null}},{key:"prepareCSSOverrideString",value:function prepareCSSOverrideString(css){return this.processGeneratedCSS(css)}},{key:"processGeneratedCSS",value:function processGeneratedCSS(css){var depth=arguments.length<=1||arguments[1]===undefined?0:arguments[1];css=css.replace(/:first-letter/gi,":not([contenteditable]):first-letter");return _get(Object.getPrototypeOf(DesignContext.prototype),"processGeneratedCSS",this).call(this,css,depth)}},{key:"processStyleString",value:function processStyleString(str){var depth=arguments.length<=1||arguments[1]===undefined?0:arguments[1];var opt=arguments.length<=2||arguments[2]===undefined?null:arguments[2];str=_get(Object.getPrototypeOf(DesignContext.prototype),"processStyleString",this).call(this,str,depth);var rules=quickParseCSSRules(str);var output="";if(!opt){opt={skipUIModifyingProperties:true,skipAnimationProperties:true}}var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=rules[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var rule=_step6.value;output+=rule.toString(opt)}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6["return"]){_iterator6["return"]()}}finally{if(_didIteratorError6){throw _iteratorError6}}}return output}},{key:"markAsSaved",value:function markAsSaved(path,historyStackID){if(path===undefined)path=null;this.lastSaveTime=Date.now();this.historyStackID=historyStackID||this.history.stackID;if(path){this.path=path}}},{key:"markAsBackedUp",value:function markAsBackedUp(historyStackID){this.backupHistoryID=historyStackID||this.history.stackID}},{key:"isActive",value:function isActive(){return app.context==this}},{key:"isSaved",value:function isSaved(){return this.existsOnDisk()&&!this.hasUnsavedChanges()}},{key:"canBeSaved",value:function canBeSaved(){return!this.isSaved()}},{key:"canBeSavedAs",value:function canBeSavedAs(){return this.existsOnDisk()}},{key:"existsOnDisk",value:function existsOnDisk(){return this.lastSaveTime!==null}},{key:"hasUnsavedChanges",value:function hasUnsavedChanges(){return this.historyStackID!=this.history.stackID}},{key:"hasChangesSinceLastBackup",value:function hasChangesSinceLastBackup(){return this.backupHistoryID!==this.history.stackID}},{key:"setThemeCSS",value:function setThemeCSS(css){this.themeCSS=css}},{key:"getAllCSS",value:function getAllCSS(){var arr=this.themeCSS.slice();var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=this.assets.css.getLocalByPriority()[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var cssResource=_step7.value;arr.push.apply(arr,cssResource.blocks)}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7["return"]){_iterator7["return"]()}}finally{if(_didIteratorError7){throw _iteratorError7}}}arr.reverse();return arr}},{key:"getAllCSSCached",value:function getAllCSSCached(){if(this._cssAllBlocksCache){return this._cssAllBlocksCache}return this._cssAllBlocksCache=this.getAllCSS()}},{key:"invalidateCSSCaches",value:function invalidateCSSCaches(){this._cssAllBlocksCache=null;this._cssMatchingCache=new WeakMap}},{key:"getMatchingCSSBlocks",value:function getMatchingCSSBlocks(node){if(this._cssMatchingCache.has(node)){return this._cssMatchingCache.get(node)}var matching=[],result=null;var _iteratorNormalCompletion8=true;var _didIteratorError8=false;var _iteratorError8=undefined;try{for(var _iterator8=this.getAllCSSCached()[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=true){var block=_step8.value;if(!block.matchesElement(node))continue;result=block.calculateSpecificityFor(node);if(!result)continue;matching.push({result:result,block:block})}}catch(err){_didIteratorError8=true;_iteratorError8=err}finally{try{if(!_iteratorNormalCompletion8&&_iterator8["return"]){_iterator8["return"]()}}finally{if(_didIteratorError8){throw _iteratorError8}}}matching=stable(matching,function(a,b){return b.result.specificity-a.result.specificity});this._cssMatchingCache.set(node,matching);return matching}},{key:"getSystemCSS",value:function getSystemCSS(){return this.themeCSS.slice()}},{key:"getUserClassNames",value:function getUserClassNames(){var s=new Set;var _iteratorNormalCompletion9=true;var _didIteratorError9=false;var _iteratorError9=undefined;try{for(var _iterator9=this.pages.getAll()[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=true){var p=_step9.value;var _iteratorNormalCompletion10=true;var _didIteratorError10=false;var _iteratorError10=undefined;try{for(var _iterator10=p.html.getAllUserClassNames()[Symbol.iterator](),_step10;!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=true){var className=_step10.value;s.add(className)}}catch(err){_didIteratorError10=true;_iteratorError10=err}finally{try{if(!_iteratorNormalCompletion10&&_iterator10["return"]){_iterator10["return"]()}}finally{if(_didIteratorError10){throw _iteratorError10}}}}}catch(err){_didIteratorError9=true;_iteratorError9=err}finally{try{if(!_iteratorNormalCompletion9&&_iterator9["return"]){_iterator9["return"]()}}finally{if(_didIteratorError9){throw _iteratorError9}}}return Array.from(s)}},{key:"setSelectedDevice",value:function setSelectedDevice(device){this.selectedDevice=device}},{key:"getSelectedDevice",value:function getSelectedDevice(){return this.selectedDevice}},{key:"selectDevice",value:function selectDevice(device){this.setSelectedDevice(device);var width=this.landscape?device.height:device.width;var height=this.landscape?device.width:device.height;app.canvas.resize({width:width,height:height})}},{key:"isDeviceSelected",value:function isDeviceSelected(name){var device=this.getSelectedDevice();if(!device)return false;var width=this.landscape?device.height:device.width;var height=this.landscape?device.width:device.height;return device.name===name&&this.canvasDimensions.width===width&&this.canvasDimensions.height===height}},{key:"switchOrientation",value:function switchOrientation(){this.landscape=!this.landscape;app.canvas.resize({width:this.canvasDimensions.height,height:this.canvasDimensions.width})}}]);return DesignContext}(Context);module.exports=DesignContext},{"../base/Canvas":16,"../base/History":19,"../editors/ActiveStyles":526,"../editors/EditorGroup":533,"../editors/HTMLTree":534,"../helpers/quickParseCSSRules":599,"./Context":371,"./PreviewContext":374,"stable":1167}]
});